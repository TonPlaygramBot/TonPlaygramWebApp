<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pool Royale Demo</title>
    <style>
      :root {
        --pocket-r: 54;
        --net-depth: 56;
      }
      body {
        margin: 0;
        background: #0c1020;
        display: grid;
        place-items: center;
        height: 100vh;
      }
      .stage {
        position: relative;
        max-width: min(92vw, 760px);
        box-shadow: 0 20px 60px rgba(0,0,0,0.35);
        border-radius: 12px;
        overflow: hidden;
      }
      .bg {
        display: block;
        width: 100%;
        height: auto;
        filter: brightness(110%);
      }
      svg.overlay {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      .aim-line {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 2px;
        height: 0;
        background: #fff;
        transform-origin: top center;
        transform: translate(-50%, -100%) rotate(0);
        pointer-events: none;
      }
      .ball {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #fff;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .target-ball {
        background: #f33;
      }
      .spin-dot {
        position: absolute;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #f00;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
      }
      #spin-controller {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255,255,255,0.25);
        cursor: crosshair;
      }
      #spin-controller .spin-dot {
        pointer-events: none;
      }
      #controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        color: #fff;
        font-family: sans-serif;
        background: rgba(0,0,0,0.3);
        padding: 6px;
        border-radius: 8px;
      }
      #controls input[type="range"] {
        width: 120px;
      }

      .config-btn {
        position: fixed;
        bottom: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: rgba(255,255,255,0.3);
        cursor: pointer;
      }

      .config-panel {
        position: fixed;
        bottom: 60px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        font-family: sans-serif;
        width: 200px;
      }

      .config-panel label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .hidden {
        display: none;
      }

      .debug-marker {
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <div class="stage">
      <img
        class="bg"
        src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAwIDE1MDAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiMwMDgwMDAiLz48L3N2Zz4="
        alt="Pool table"
      />
      <svg id="frame" class="overlay debug-marker" viewBox="0 0 1000 1500"></svg>
      <div id="aim-line" class="aim-line debug-marker"></div>
      <div id="cue-ball" class="ball">
        <div id="cue-spin-dot" class="spin-dot debug-marker"></div>
      </div>
      <div id="target-ball" class="ball target-ball debug-marker"></div>
      <div id="controls">
        <input id="power" type="range" min="0" max="100" value="40" />
        <button id="shoot">Shoot</button>
      </div>
      <div id="spin-controller">
        <div id="spin-controller-dot" class="spin-dot debug-marker"></div>
      </div>
    </div>
    <button id="config-btn" class="config-btn">⚙️</button>
    <div id="config-panel" class="config-panel hidden">
      <label>Ball Volume:
        <input id="volume" type="range" min="0" max="100" value="50" />
        <span id="volume-value">50%</span>
      </label>
      <label>Brightness:
        <input id="brightness" type="range" min="50" max="150" value="110" />
        <span id="brightness-value">110%</span>
      </label>
      <label>Frame Style:
        <select id="frame-select">
          <option value="classic">Classic</option>
          <option value="minimal">Minimal</option>
          <option value="neon">Neon</option>
          <option value="retro">Retro</option>
        </select>
      </label>
      <label>Pocket Jaw Rims:
        <select id="pocket-select">
          <option value="matte-ebony">Matte Ebony Wrap</option>
          <option value="polished-chrome">Polished Chrome Sweep</option>
          <option value="burnished-brass">Burnished Brass Curve</option>
          <option value="carbon-weave">Carbon Weave Guard</option>
          <option value="aurora-neon">Aurora Neon Halo</option>
        </select>
      </label>
      <label>Frame Color:
        <input id="frame-color" type="color" value="#ff0000" />
      </label>
      <label>Card Color:
        <input id="card-color" type="color" value="#000000" />
      </label>
    </div>
    <script>
      const stage = document.querySelector('.stage');
      const aimLine = document.getElementById('aim-line');
      const cueBall = document.getElementById('cue-ball');
      const targetBall = document.getElementById('target-ball');
      const powerInput = document.getElementById('power');
      const shootBtn = document.getElementById('shoot');
      const spinController = document.getElementById('spin-controller');
      const spinControllerDot = document.getElementById('spin-controller-dot');
      const cueSpinDot = document.getElementById('cue-spin-dot');
      const configBtn = document.getElementById('config-btn');
      const configPanel = document.getElementById('config-panel');
      const volumeSlider = document.getElementById('volume');
      const volumeValue = document.getElementById('volume-value');
      const brightnessSlider = document.getElementById('brightness');
      const brightnessValue = document.getElementById('brightness-value');
      const bgImage = document.querySelector('.bg');
      const frameSelect = document.getElementById('frame-select');
      const pocketSelect = document.getElementById('pocket-select');
      const frameColorInput = document.getElementById('frame-color');
      const cardColorInput = document.getElementById('card-color');
      const controls = document.getElementById('controls');
      const frameSvg = document.getElementById('frame');

      const frameTemplates = {
        classic: (color) => `
        <rect x="80" y="80" width="840" height="1340" fill="rgba(0,255,0,0.15)" stroke="${color}" stroke-width="20" />
        <rect x="20" y="20" width="960" height="1460" fill="none" stroke="${color}" stroke-width="40" />`,
        minimal: (color) => `
        <rect x="40" y="40" width="920" height="1420" fill="none" stroke="${color}" stroke-width="20" />`,
        neon: (color) => `
        <rect x="60" y="60" width="880" height="1380" fill="none" stroke="${color}" stroke-width="25" stroke-dasharray="10 5" />`,
        retro: (color) => `
        <rect x="30" y="30" width="940" height="1440" fill="none" stroke="${color}" stroke-width="30" />`
      };

      const CORNER_TRANSFORMS = [
        'translate(140 140)',
        'translate(860 140) scale(-1 1)',
        'translate(860 1360) scale(-1 -1)',
        'translate(140 1360) scale(1 -1)'
      ];

      const SIDE_TRANSFORMS = [
        'translate(500 90)',
        'translate(500 1410) scale(1 -1)'
      ];

      function cornerArc(radius, options = {}) {
        const { color, width, dash, opacity = 1, linecap = 'round' } = options;
        if (!color || !width) return '';
        const dashAttr = dash ? ` stroke-dasharray="${dash}"` : '';
        return `<path d="M 0 ${radius} A ${radius} ${radius} 0 0 1 ${radius} 0" stroke="${color}" stroke-width="${width}" stroke-linecap="${linecap}" stroke-linejoin="round" stroke-opacity="${opacity}" fill="none"${dashAttr} />`;
      }

      function sideArc(radius, options = {}) {
        const { color, width, dash, opacity = 1, linecap = 'round' } = options;
        if (!color || !width) return '';
        const dashAttr = dash ? ` stroke-dasharray="${dash}"` : '';
        return `<path d="M -${radius} 0 A ${radius} ${radius} 0 0 1 ${radius} 0" stroke="${color}" stroke-width="${width}" stroke-linecap="${linecap}" stroke-linejoin="round" stroke-opacity="${opacity}" fill="none"${dashAttr} />`;
      }

      function createCornerLip(radius, lip = {}) {
        const { color, width, length, dash, opacity = 1, cap = 'round', inset = 0 } = lip;
        if (!color || !width || !length) return '';
        const dashAttr = dash ? ` stroke-dasharray="${dash}"` : '';
        const start = inset;
        return `
          <line x1="${start}" y1="0" x2="${start - length}" y2="0" stroke="${color}" stroke-width="${width}" stroke-linecap="${cap}" stroke-opacity="${opacity}"${dashAttr} />
          <line x1="0" y1="${start}" x2="0" y2="${start - length}" stroke="${color}" stroke-width="${width}" stroke-linecap="${cap}" stroke-opacity="${opacity}"${dashAttr} />
        `;
      }

      function createSideLip(lip = {}) {
        const { color, width, length, dash, opacity = 1, cap = 'round', offset = 0 } = lip;
        if (!color || !width || !length) return '';
        const dashAttr = dash ? ` stroke-dasharray="${dash}"` : '';
        return `
          <line x1="${-length}" y1="${offset}" x2="${length}" y2="${offset}" stroke="${color}" stroke-width="${width}" stroke-linecap="${cap}" stroke-opacity="${opacity}"${dashAttr} />
          <line x1="0" y1="${offset}" x2="0" y2="${offset - length}" stroke="${color}" stroke-width="${width}" stroke-linecap="${cap}" stroke-opacity="${opacity}"${dashAttr} />
        `;
      }

      function createPocketMarkup(cfg = {}) {
        const cornerRadius = cfg.cornerRadius ?? 118;
        const sideRadius = cfg.sideRadius ?? 112;

        const cornerSegments = [];
        const cornerDefs = [
          cfg.cornerRim && { radius: cornerRadius, ...cfg.cornerRim },
          cfg.cornerAccent && { radius: Math.max(0, cornerRadius - (cfg.cornerAccent.offset ?? 0)), ...cfg.cornerAccent },
          cfg.cornerHighlight && { radius: Math.max(0, cornerRadius - (cfg.cornerHighlight.offset ?? 0)), ...cfg.cornerHighlight },
          cfg.cornerInner && { radius: Math.max(0, cornerRadius - (cfg.cornerInner.offset ?? 0)), ...cfg.cornerInner }
        ].filter(Boolean);
        cornerDefs.forEach((def) => {
          cornerSegments.push(cornerArc(def.radius, def));
        });

        if (cfg.cornerLip) {
          cornerSegments.push(createCornerLip(cornerRadius, cfg.cornerLip));
        }
        if (cfg.cornerLipSecondary) {
          cornerSegments.push(createCornerLip(cornerRadius, cfg.cornerLipSecondary));
        }

        const sideSegments = [];
        const sideDefs = [
          cfg.sideRim && { radius: sideRadius, ...cfg.sideRim },
          cfg.sideAccent && { radius: Math.max(0, sideRadius - (cfg.sideAccent.offset ?? 0)), ...cfg.sideAccent },
          cfg.sideHighlight && { radius: Math.max(0, sideRadius - (cfg.sideHighlight.offset ?? 0)), ...cfg.sideHighlight },
          cfg.sideInner && { radius: Math.max(0, sideRadius - (cfg.sideInner.offset ?? 0)), ...cfg.sideInner }
        ].filter(Boolean);
        sideDefs.forEach((def) => {
          sideSegments.push(sideArc(def.radius, def));
        });

        if (cfg.sideLip) {
          sideSegments.push(createSideLip(cfg.sideLip));
        }
        if (cfg.sideLipSecondary) {
          sideSegments.push(createSideLip(cfg.sideLipSecondary));
        }

        const cornerMarkup = cornerSegments.join('');
        const sideMarkup = sideSegments.join('');

        return `
          <g class="pocket-rims" fill="none">
            ${CORNER_TRANSFORMS.map((transform) => `<g transform="${transform}">${cornerMarkup}</g>`).join('')}
            ${SIDE_TRANSFORMS.map((transform) => `<g transform="${transform}">${sideMarkup}</g>`).join('')}
          </g>
        `;
      }

      const pocketStyles = {
        'matte-ebony': {
          render: (uid) => ({
            markup: createPocketMarkup({
              cornerRadius: 118,
              sideRadius: 114,
              cornerRim: { color: '#1b1f24', width: 28 },
              cornerAccent: { offset: 12, color: '#3a424c', width: 6, dash: '14 6', opacity: 0.6 },
              cornerHighlight: { offset: 20, color: '#5c6570', width: 4, opacity: 0.45 },
              cornerLip: { color: '#2a3038', width: 18, length: 96, opacity: 0.85 },
              sideRim: { color: '#1b1f24', width: 26 },
              sideAccent: { offset: 10, color: '#3a424c', width: 6, dash: '12 8', opacity: 0.6 },
              sideHighlight: { offset: 18, color: '#5c6570', width: 4, opacity: 0.45 },
              sideLip: { color: '#2a3038', width: 16, length: 140, opacity: 0.85 }
            })
          })
        },
        'polished-chrome': {
          render: (uid) => ({
            defs: `
              <linearGradient id="${uid}-rim" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#f5f7fa" />
                <stop offset="45%" stop-color="#c8ccd3" />
                <stop offset="65%" stop-color="#ffffff" />
                <stop offset="100%" stop-color="#9ea3ab" />
              </linearGradient>
              <linearGradient id="${uid}-accent" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#d7dbe2" stop-opacity="0.9" />
                <stop offset="100%" stop-color="#ffffff" stop-opacity="0.4" />
              </linearGradient>
            `,
            markup: createPocketMarkup({
              cornerRadius: 122,
              sideRadius: 118,
              cornerRim: { color: `url(#${uid}-rim)`, width: 30, linecap: 'butt' },
              cornerAccent: { offset: 10, color: '#fdfefe', width: 6, opacity: 0.75 },
              cornerHighlight: { offset: 18, color: `url(#${uid}-accent)`, width: 8, dash: '16 9', opacity: 0.9 },
              cornerLip: { color: '#d5dae3', width: 16, length: 108, cap: 'butt', opacity: 0.9 },
              sideRim: { color: `url(#${uid}-rim)`, width: 28, linecap: 'butt' },
              sideAccent: { offset: 8, color: '#ffffff', width: 5, opacity: 0.75 },
              sideHighlight: { offset: 16, color: `url(#${uid}-accent)`, width: 9, dash: '18 10', opacity: 0.9 },
              sideLip: { color: '#d5dae3', width: 16, length: 156, cap: 'butt', opacity: 0.9 }
            })
          })
        },
        'burnished-brass': {
          render: (uid) => ({
            defs: `
              <linearGradient id="${uid}-brass" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#f0d99b" />
                <stop offset="50%" stop-color="#c99a3d" />
                <stop offset="100%" stop-color="#7f5415" />
              </linearGradient>
              <linearGradient id="${uid}-brass-glow" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#ffe4b3" stop-opacity="0.9" />
                <stop offset="100%" stop-color="#ffd27d" stop-opacity="0.3" />
              </linearGradient>
            `,
            markup: createPocketMarkup({
              cornerRadius: 120,
              sideRadius: 116,
              cornerRim: { color: `url(#${uid}-brass)`, width: 30 },
              cornerAccent: { offset: 14, color: '#ffdca2', width: 7, opacity: 0.7 },
              cornerHighlight: { offset: 22, color: `url(#${uid}-brass-glow)`, width: 6, dash: '10 7', opacity: 0.8 },
              cornerLip: { color: '#8c6121', width: 18, length: 104, opacity: 0.85 },
              cornerLipSecondary: { color: '#f1d296', width: 8, length: 84, opacity: 0.6, dash: '8 6' },
              sideRim: { color: `url(#${uid}-brass)`, width: 28 },
              sideAccent: { offset: 12, color: '#ffdca2', width: 7, opacity: 0.7 },
              sideHighlight: { offset: 20, color: `url(#${uid}-brass-glow)`, width: 6, dash: '12 8', opacity: 0.8 },
              sideLip: { color: '#8c6121', width: 18, length: 150, opacity: 0.85 },
              sideLipSecondary: { color: '#f1d296', width: 7, length: 130, opacity: 0.6, dash: '9 6' }
            })
          })
        },
        'carbon-weave': {
          render: (uid) => ({
            defs: `
              <pattern id="${uid}-hatch" width="6" height="6" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                <rect x="0" y="0" width="6" height="6" fill="#111" />
                <rect x="0" y="0" width="3" height="6" fill="#1f1f1f" />
              </pattern>
            `,
            markup: createPocketMarkup({
              cornerRadius: 118,
              sideRadius: 114,
              cornerRim: { color: `url(#${uid}-hatch)`, width: 32, linecap: 'butt' },
              cornerAccent: { offset: 10, color: '#2f363c', width: 6, dash: '6 6', opacity: 0.9 },
              cornerHighlight: { offset: 18, color: '#6ad0ff', width: 4, opacity: 0.55 },
              cornerInner: { offset: 26, color: '#0f1114', width: 10, opacity: 0.9 },
              cornerLip: { color: '#262c32', width: 18, length: 102, opacity: 0.9 },
              sideRim: { color: `url(#${uid}-hatch)`, width: 30, linecap: 'butt' },
              sideAccent: { offset: 8, color: '#2f363c', width: 6, dash: '8 8', opacity: 0.9 },
              sideHighlight: { offset: 16, color: '#6ad0ff', width: 4, opacity: 0.55 },
              sideInner: { offset: 24, color: '#0f1114', width: 10, opacity: 0.9 },
              sideLip: { color: '#262c32', width: 18, length: 150, opacity: 0.9 }
            })
          })
        },
        'aurora-neon': {
          render: (uid) => ({
            defs: `
              <radialGradient id="${uid}-glow" cx="50%" cy="50%" r="70%">
                <stop offset="0%" stop-color="#00ffd1" stop-opacity="0.95" />
                <stop offset="60%" stop-color="#00c9ff" stop-opacity="0.6" />
                <stop offset="100%" stop-color="#0059ff" stop-opacity="0.2" />
              </radialGradient>
            `,
            markup: createPocketMarkup({
              cornerRadius: 120,
              sideRadius: 116,
              cornerRim: { color: '#0e1224', width: 30 },
              cornerAccent: { offset: 12, color: '#00ffd1', width: 8, opacity: 0.9 },
              cornerHighlight: { offset: 20, color: `url(#${uid}-glow)`, width: 10, opacity: 0.75 },
              cornerLip: { color: '#0e1224', width: 18, length: 120, opacity: 0.9 },
              cornerLipSecondary: { color: '#00ffd1', width: 6, length: 86, opacity: 0.7, dash: '4 6' },
              sideRim: { color: '#0e1224', width: 28 },
              sideAccent: { offset: 10, color: '#00ffd1', width: 8, opacity: 0.9 },
              sideHighlight: { offset: 20, color: `url(#${uid}-glow)`, width: 10, opacity: 0.75 },
              sideLip: { color: '#0e1224', width: 18, length: 160, opacity: 0.9 },
              sideLipSecondary: { color: '#00ffd1', width: 6, length: 120, opacity: 0.7, dash: '4 6' }
            })
          })
        }
      };

      let ballVolume = volumeSlider.value / 100;
      bgImage.style.filter = `brightness(${brightnessSlider.value}%)`;

      brightnessValue.textContent = `${brightnessSlider.value}%`;
      brightnessSlider.addEventListener('input', () => {
        const val = brightnessSlider.value;
        brightnessValue.textContent = `${val}%`;
        bgImage.style.filter = `brightness(${val}%)`;
      });

      function renderFrame() {
        const frameColor = frameColorInput.value;
        const frameStyle = frameSelect.value;
        const pocketStyle = pocketSelect.value;
        const frameMarkup = frameTemplates[frameStyle] ? frameTemplates[frameStyle](frameColor) : '';
        const pocketConfig = pocketStyles[pocketStyle];
        const uid = `pocket-${pocketStyle}`;
        const pocketResult = pocketConfig ? pocketConfig.render(uid) : null;
        const defs = pocketResult && pocketResult.defs ? `<defs>${pocketResult.defs}</defs>` : '';
        const pockets = pocketResult && pocketResult.markup ? pocketResult.markup : '';
        frameSvg.innerHTML = `${defs}${frameMarkup}${pockets}`;
      }

      renderFrame();

      configBtn.addEventListener('click', () => {
        configPanel.classList.toggle('hidden');
      });

      volumeSlider.addEventListener('input', () => {
        ballVolume = volumeSlider.value / 100;
        volumeValue.textContent = `${volumeSlider.value}%`;
      });

      frameSelect.addEventListener('change', renderFrame);
      pocketSelect.addEventListener('change', renderFrame);
      frameColorInput.addEventListener('input', renderFrame);
      cardColorInput.addEventListener('input', () => {
        controls.style.background = cardColorInput.value;
      });

      let shotDir = { x: 0, y: -1 };
      let shotLength = 0;
      let spin = { x: 0, y: 0 };

      const rect = stage.getBoundingClientRect();
      const center = { x: rect.width / 2, y: rect.height / 2 };

      cueBall.style.left = `${center.x}px`;
      cueBall.style.top = `${center.y}px`;
      targetBall.style.left = `${center.x}px`;
      targetBall.style.top = `${center.y}px`;

      stage.addEventListener('click', (e) => {
        const r = stage.getBoundingClientRect();
        const cx = r.left + r.width / 2;
        const cy = r.top + r.height / 2;
        const dx = e.clientX - cx;
        const dy = e.clientY - cy;
        const angle = (Math.atan2(dy, dx) * 180) / Math.PI + 90;
        const length = Math.hypot(dx, dy);
        shotDir = { x: dx / length, y: dy / length };
        shotLength = length;
        aimLine.style.height = `${length}px`;
        aimLine.style.transform = `translate(-50%,-100%) rotate(${angle}deg)`;

        const tbx = center.x + shotDir.x * 200;
        const tby = center.y + shotDir.y * 200;
        targetBall.style.left = `${tbx}px`;
        targetBall.style.top = `${tby}px`;
      });

      function updateSpinDots (sx, sy) {
        const max = 40; // percentage offset inside parent
        const pos = (val) => `${50 + val * max}%`;
        spinControllerDot.style.left = pos(sx);
        spinControllerDot.style.top = pos(sy);
        cueSpinDot.style.left = pos(sx);
        // move the cue ball's spin indicator to mirror controller input
        cueSpinDot.style.top = pos(sy);
      }

      // update spin both on click and while dragging for better precision
      let spinning = false;
      function setSpin (e) {
        if (e.type === 'pointermove' && !spinning) return;
        const r = spinController.getBoundingClientRect();
        const cx = r.width / 2;
        const cy = r.height / 2;
        const dx = e.clientX - r.left - cx;
        const dy = e.clientY - r.top - cy;
        const nx = Math.max(Math.min(dx / cx, 1), -1);
        const ny = Math.max(Math.min(dy / cy, 1), -1);
        // invert the vertical component so positive y is top spin
        spin = { x: nx, y: -ny };
        updateSpinDots(nx, ny);
      }
      spinController.addEventListener('pointerdown', (e) => {
        spinning = true;
        spinController.setPointerCapture(e.pointerId);
        setSpin(e);
      });
      spinController.addEventListener('pointermove', setSpin);
      spinController.addEventListener('pointerup', (e) => {
        spinning = false;
        spinController.releasePointerCapture(e.pointerId);
      });

      function playHit(power) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.frequency.value = 400;
        const volume = ballVolume * (power > 0.4 ? 0.3 : 0.8);
        gain.gain.value = volume;
        osc.connect(gain).connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.1);
      }

      function shoot() {
        const power = Number(powerInput.value) / 100;
        playHit(power);
        const speed = 4 + power * 9;
        let cuePos = { x: center.x, y: center.y };
        let cueVel = { x: shotDir.x * speed, y: shotDir.y * speed };
        let targetPos = {
          x: parseFloat(targetBall.style.left),
          y: parseFloat(targetBall.style.top)
        };
        let targetVel = { x: 0, y: 0 };
        let collided = false;
        let targetTravel = 0;

        function frame() {
          if (!collided) {
            cuePos.x += cueVel.x;
            cuePos.y += cueVel.y;
            cueBall.style.left = `${cuePos.x}px`;
            cueBall.style.top = `${cuePos.y}px`;
            const dx = cuePos.x - targetPos.x;
            const dy = cuePos.y - targetPos.y;
            if (Math.hypot(dx, dy) <= 40) {
              collided = true;
              // apply spin to cue ball after collision
              const forward = spin.y; // top spin is positive
              const side = spin.x;
              const spinScale = speed; // stronger influence for clearer draw/follow
              cueVel = {
                x: shotDir.x * forward * spinScale + -shotDir.y * side * spinScale,
                y: shotDir.y * forward * spinScale + shotDir.x * side * spinScale
              };
              targetVel = { x: shotDir.x * speed, y: shotDir.y * speed };
            }
          } else {
            cuePos.x += cueVel.x;
            cuePos.y += cueVel.y;
            cueVel.x *= 0.96;
            cueVel.y *= 0.96;
            cueBall.style.left = `${cuePos.x}px`;
            cueBall.style.top = `${cuePos.y}px`;
            if (targetTravel < 200) {
              targetPos.x += targetVel.x;
              targetPos.y += targetVel.y;
              targetBall.style.left = `${targetPos.x}px`;
              targetBall.style.top = `${targetPos.y}px`;
              targetTravel += speed;
            } else if (Math.hypot(cueVel.x, cueVel.y) < 0.1) {
              return;
            }
          }
          requestAnimationFrame(frame);
        }
        requestAnimationFrame(frame);
      }

      shootBtn.addEventListener('click', shoot);

      function setDebugVisible (visible) {
        document.querySelectorAll('.debug-marker').forEach((el) => {
          el.style.visibility = visible ? 'visible' : 'hidden';
        });
      }
      window.showDebugMarkers = () => setDebugVisible(true);
      window.hideDebugMarkers = () => setDebugVisible(false);
      setDebugVisible(true);
    </script>
    <script type="module" src="./royale-physics.js"></script>
  </body>
</html>
