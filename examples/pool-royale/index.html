<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pool Royale Demo</title>
    <style>
      :root {
        --pocket-r: 54;
        --net-depth: 56;
      }
      body {
        margin: 0;
        background: #0c1020;
        display: grid;
        place-items: center;
        height: 100vh;
      }
      .stage {
        position: relative;
        max-width: min(92vw, 760px);
        box-shadow: 0 20px 60px rgba(0,0,0,0.35);
        border-radius: 12px;
        overflow: hidden;
      }
      .bg {
        display: block;
        width: 100%;
        height: auto;
        filter: brightness(110%);
      }
      svg.overlay {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      .aim-line {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 2px;
        height: 0;
        background: #fff;
        transform-origin: top center;
        transform: translate(-50%, -100%) rotate(0);
        pointer-events: none;
      }
      .ball {
        position: absolute;
        width: 42px;
        height: 42px;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        --ball-color: #fff;
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.6) 30%, rgba(255,255,255,0) 65%),
          radial-gradient(circle at 50% 60%, var(--ball-color) 0%, var(--ball-color) 70%, rgba(0,0,0,0.25) 100%);
        box-shadow: inset 0 4px 8px rgba(255,255,255,0.55), inset 0 -6px 10px rgba(0,0,0,0.45), 0 6px 10px rgba(0,0,0,0.35);
      }
      .ball::after {
        content: '';
        position: absolute;
        top: 18%;
        left: 20%;
        width: 45%;
        height: 45%;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(255,255,255,0.9), rgba(255,255,255,0));
        filter: blur(0.5px);
      }
      .target-ball {
        --ball-color: #f33;
      }
      .spin-dot {
        position: absolute;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #f00;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
      }
      #spin-controller {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255,255,255,0.25);
        cursor: crosshair;
      }
      #spin-controller .spin-dot {
        pointer-events: none;
      }
      #controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        color: #fff;
        font-family: sans-serif;
        background: rgba(0,0,0,0.3);
        padding: 6px;
        border-radius: 8px;
      }
      #controls input[type="range"] {
        width: 120px;
      }

      .config-btn {
        position: fixed;
        bottom: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: rgba(255,255,255,0.3);
        cursor: pointer;
      }

      .config-panel {
        position: fixed;
        bottom: 60px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 10px;
        border-radius: 8px;
        font-family: sans-serif;
        width: 200px;
      }

      .config-panel label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .hidden {
        display: none;
      }

      .debug-marker {
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <div class="stage">
      <img
        class="bg"
        src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNjAwIDkwMCI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9Indvb2QiIHgxPSIwIiB5MT0iMCIgeDI9IjAiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjNWMzYjFkIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMC41IiBzdG9wLWNvbG9yPSIjN2E0ZDI2Ii8+CiAgICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzRhMmIxNSIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iY2xvdGgiIGN4PSI1MCUiIGN5PSI0NSUiIHI9IjY1JSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iIzJjYTE2NCIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjAuNDUiIHN0b3AtY29sb3I9IiMxODg2NGUiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjMGQ1YzMyIi8+CiAgICA8L3JhZGlhbEdyYWRpZW50PgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJjdXNoaW9uIiB4MT0iMCIgeTE9IjAiIHgyPSIwIiB5Mj0iMSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iIzFmNmYzZCIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjAuNSIgc3RvcC1jb2xvcj0iIzE1NTkzMCIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiMxMDQzMjYiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgICA8cmFkaWFsR3JhZGllbnQgaWQ9InBvY2tldCIgY3g9IjUwJSIgY3k9IjUwJSIgcj0iNTAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjMmQyZDJkIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMC41NSIgc3RvcC1jb2xvcj0iIzBlMGUwZSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiMwMDAiLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgICA8ZmlsdGVyIGlkPSJjbG90aFRleHR1cmUiIHg9Ii0xMCUiIHk9Ii0xMCUiIHdpZHRoPSIxMjAlIiBoZWlnaHQ9IjEyMCUiPgogICAgICA8ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC45IiBudW1PY3RhdmVzPSIyIiBzZWVkPSIxMiIgcmVzdWx0PSJub2lzZSIvPgogICAgICA8ZmVDb2xvck1hdHJpeCBpbj0ibm9pc2UiIHR5cGU9Im1hdHJpeCIgdmFsdWVzPSIwIDAgMCAwIDAgIDAgMCAwIDAgMCAgMCAwIDAgMCAwICAwIDAgMCAwLjMgMCIgcmVzdWx0PSJncmFpbiIvPgogICAgICA8ZmVCbGVuZCBpbj0iU291cmNlR3JhcGhpYyIgaW4yPSJncmFpbiIgbW9kZT0ibXVsdGlwbHkiLz4KICAgIDwvZmlsdGVyPgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTYwMCIgaGVpZ2h0PSI5MDAiIGZpbGw9InVybCgjd29vZCkiLz4KICA8cmVjdCB4PSIxMjAiIHk9IjkwIiB3aWR0aD0iMTM2MCIgaGVpZ2h0PSI3MjAiIHJ4PSI5MCIgcnk9IjkwIiBmaWxsPSJ1cmwoI2N1c2hpb24pIi8+CiAgPHJlY3QgeD0iMjAwIiB5PSIxNjAiIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU4MCIgcng9IjYwIiByeT0iNjAiIGZpbGw9InVybCgjY2xvdGgpIiBmaWx0ZXI9InVybCgjY2xvdGhUZXh0dXJlKSIvPgogIDxnIGZpbGw9InVybCgjcG9ja2V0KSI+CiAgICA8Y2lyY2xlIGN4PSIyMDAiIGN5PSIxNjAiIHI9IjYwIi8+CiAgICA8Y2lyY2xlIGN4PSI4MDAiIGN5PSIxNjAiIHI9IjY0Ii8+CiAgICA8Y2lyY2xlIGN4PSIxNDAwIiBjeT0iMTYwIiByPSI2MCIvPgogICAgPGNpcmNsZSBjeD0iMjAwIiBjeT0iNzQwIiByPSI2MCIvPgogICAgPGNpcmNsZSBjeD0iODAwIiBjeT0iNzQwIiByPSI2NCIvPgogICAgPGNpcmNsZSBjeD0iMTQwMCIgY3k9Ijc0MCIgcj0iNjAiLz4KICA8L2c+CiAgPHJlY3QgeD0iMjAwIiB5PSIxNjAiIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU4MCIgcng9IjYwIiByeT0iNjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZmZmZjEyIiBzdHJva2Utd2lkdGg9IjYiLz4KPC9zdmc+"
        alt="Pool table"
      />
      <svg id="frame" class="overlay debug-marker" viewBox="0 0 1000 1500"></svg>
      <div id="aim-line" class="aim-line debug-marker"></div>
      <div id="cue-ball" class="ball">
        <div id="cue-spin-dot" class="spin-dot debug-marker"></div>
      </div>
      <div id="target-ball" class="ball target-ball debug-marker"></div>
      <div id="controls">
        <input id="power" type="range" min="0" max="100" value="40" />
        <button id="shoot">Shoot</button>
      </div>
      <div id="spin-controller">
        <div id="spin-controller-dot" class="spin-dot debug-marker"></div>
      </div>
    </div>
    <button id="config-btn" class="config-btn">⚙️</button>
    <div id="config-panel" class="config-panel hidden">
      <label>Ball Volume:
        <input id="volume" type="range" min="0" max="100" value="50" />
        <span id="volume-value">50%</span>
      </label>
      <label>Brightness:
        <input id="brightness" type="range" min="50" max="150" value="110" />
        <span id="brightness-value">110%</span>
      </label>
      <label>Frame Style:
        <select id="frame-select">
          <option value="classic">Classic</option>
          <option value="minimal">Minimal</option>
          <option value="neon">Neon</option>
          <option value="retro">Retro</option>
        </select>
      </label>
      <label>Frame Color:
        <input id="frame-color" type="color" value="#ff0000" />
      </label>
      <label>Card Color:
        <input id="card-color" type="color" value="#000000" />
      </label>
    </div>
    <script>
      const stage = document.querySelector('.stage');
      const aimLine = document.getElementById('aim-line');
      const cueBall = document.getElementById('cue-ball');
      const targetBall = document.getElementById('target-ball');
      const powerInput = document.getElementById('power');
      const shootBtn = document.getElementById('shoot');
      const spinController = document.getElementById('spin-controller');
      const spinControllerDot = document.getElementById('spin-controller-dot');
      const cueSpinDot = document.getElementById('cue-spin-dot');
      const configBtn = document.getElementById('config-btn');
      const configPanel = document.getElementById('config-panel');
      const volumeSlider = document.getElementById('volume');
      const volumeValue = document.getElementById('volume-value');
      const brightnessSlider = document.getElementById('brightness');
      const brightnessValue = document.getElementById('brightness-value');
      const bgImage = document.querySelector('.bg');
      const frameSelect = document.getElementById('frame-select');
      const frameColorInput = document.getElementById('frame-color');
      const cardColorInput = document.getElementById('card-color');
      const controls = document.getElementById('controls');
      const frameSvg = document.getElementById('frame');

      let ballVolume = volumeSlider.value / 100;
      bgImage.style.filter = `brightness(${brightnessSlider.value}%)`;

      brightnessValue.textContent = `${brightnessSlider.value}%`;
      brightnessSlider.addEventListener('input', () => {
        const val = brightnessSlider.value;
        brightnessValue.textContent = `${val}%`;
        bgImage.style.filter = `brightness(${val}%)`;
      });

      function renderFrame() {
        const color = frameColorInput.value;
        const style = frameSelect.value;
        const templates = {
          classic: `
        <rect x="80" y="80" width="840" height="1340" fill="rgba(0,255,0,0.15)" stroke="${color}" stroke-width="20" />
        <rect x="20" y="20" width="960" height="1460" fill="none" stroke="${color}" stroke-width="40" />`,
          minimal: `
        <rect x="40" y="40" width="920" height="1420" fill="none" stroke="${color}" stroke-width="20" />`,
          neon: `
        <rect x="60" y="60" width="880" height="1380" fill="none" stroke="${color}" stroke-width="25" stroke-dasharray="10 5" />`,
          retro: `
        <rect x="30" y="30" width="940" height="1440" fill="none" stroke="${color}" stroke-width="30" />`
        };
        frameSvg.innerHTML = templates[style];
      }

      renderFrame();

      configBtn.addEventListener('click', () => {
        configPanel.classList.toggle('hidden');
      });

      volumeSlider.addEventListener('input', () => {
        ballVolume = volumeSlider.value / 100;
        volumeValue.textContent = `${volumeSlider.value}%`;
      });

      frameSelect.addEventListener('change', renderFrame);
      frameColorInput.addEventListener('input', renderFrame);
      cardColorInput.addEventListener('input', () => {
        controls.style.background = cardColorInput.value;
      });

      let shotDir = { x: 0, y: -1 };
      let shotLength = 0;
      let spin = { x: 0, y: 0 };

      const rect = stage.getBoundingClientRect();
      const center = { x: rect.width / 2, y: rect.height / 2 };

      cueBall.style.left = `${center.x}px`;
      cueBall.style.top = `${center.y}px`;
      targetBall.style.left = `${center.x}px`;
      targetBall.style.top = `${center.y}px`;

      stage.addEventListener('click', (e) => {
        const r = stage.getBoundingClientRect();
        const cx = r.left + r.width / 2;
        const cy = r.top + r.height / 2;
        const dx = e.clientX - cx;
        const dy = e.clientY - cy;
        const angle = (Math.atan2(dy, dx) * 180) / Math.PI + 90;
        const length = Math.hypot(dx, dy);
        shotDir = { x: dx / length, y: dy / length };
        shotLength = length;
        aimLine.style.height = `${length}px`;
        aimLine.style.transform = `translate(-50%,-100%) rotate(${angle}deg)`;

        const tbx = center.x + shotDir.x * 200;
        const tby = center.y + shotDir.y * 200;
        targetBall.style.left = `${tbx}px`;
        targetBall.style.top = `${tby}px`;
      });

      function updateSpinDots (sx, sy) {
        const max = 40; // percentage offset inside parent
        const pos = (val) => `${50 + val * max}%`;
        spinControllerDot.style.left = pos(sx);
        spinControllerDot.style.top = pos(sy);
        cueSpinDot.style.left = pos(sx);
        // move the cue ball's spin indicator to mirror controller input
        cueSpinDot.style.top = pos(sy);
      }

      // update spin both on click and while dragging for better precision
      let spinning = false;
      function setSpin (e) {
        if (e.type === 'pointermove' && !spinning) return;
        const r = spinController.getBoundingClientRect();
        const cx = r.width / 2;
        const cy = r.height / 2;
        const dx = e.clientX - r.left - cx;
        const dy = e.clientY - r.top - cy;
        const nx = Math.max(Math.min(dx / cx, 1), -1);
        const ny = Math.max(Math.min(dy / cy, 1), -1);
        // invert the vertical component so positive y is top spin
        spin = { x: nx, y: -ny };
        updateSpinDots(nx, ny);
      }
      spinController.addEventListener('pointerdown', (e) => {
        spinning = true;
        spinController.setPointerCapture(e.pointerId);
        setSpin(e);
      });
      spinController.addEventListener('pointermove', setSpin);
      spinController.addEventListener('pointerup', (e) => {
        spinning = false;
        spinController.releasePointerCapture(e.pointerId);
      });

      function playHit(power) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.frequency.value = 400;
        const volume = ballVolume * (power > 0.4 ? 0.3 : 0.8);
        gain.gain.value = volume;
        osc.connect(gain).connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.1);
      }

      function shoot() {
        const power = Number(powerInput.value) / 100;
        playHit(power);
        const speed = 4 + power * 9;
        let cuePos = { x: center.x, y: center.y };
        let cueVel = { x: shotDir.x * speed, y: shotDir.y * speed };
        let targetPos = {
          x: parseFloat(targetBall.style.left),
          y: parseFloat(targetBall.style.top)
        };
        let targetVel = { x: 0, y: 0 };
        let collided = false;
        let targetTravel = 0;

        function frame() {
          if (!collided) {
            cuePos.x += cueVel.x;
            cuePos.y += cueVel.y;
            cueBall.style.left = `${cuePos.x}px`;
            cueBall.style.top = `${cuePos.y}px`;
            const dx = cuePos.x - targetPos.x;
            const dy = cuePos.y - targetPos.y;
            if (Math.hypot(dx, dy) <= 40) {
              collided = true;
              // apply spin to cue ball after collision
              const forward = spin.y; // top spin is positive
              const side = spin.x;
              const spinScale = speed; // stronger influence for clearer draw/follow
              cueVel = {
                x: shotDir.x * forward * spinScale + -shotDir.y * side * spinScale,
                y: shotDir.y * forward * spinScale + shotDir.x * side * spinScale
              };
              targetVel = { x: shotDir.x * speed, y: shotDir.y * speed };
            }
          } else {
            cuePos.x += cueVel.x;
            cuePos.y += cueVel.y;
            cueVel.x *= 0.96;
            cueVel.y *= 0.96;
            cueBall.style.left = `${cuePos.x}px`;
            cueBall.style.top = `${cuePos.y}px`;
            if (targetTravel < 200) {
              targetPos.x += targetVel.x;
              targetPos.y += targetVel.y;
              targetBall.style.left = `${targetPos.x}px`;
              targetBall.style.top = `${targetPos.y}px`;
              targetTravel += speed;
            } else if (Math.hypot(cueVel.x, cueVel.y) < 0.1) {
              return;
            }
          }
          requestAnimationFrame(frame);
        }
        requestAnimationFrame(frame);
      }

      shootBtn.addEventListener('click', shoot);

      function setDebugVisible (visible) {
        document.querySelectorAll('.debug-marker').forEach((el) => {
          el.style.visibility = visible ? 'visible' : 'hidden';
        });
      }
      window.showDebugMarkers = () => setDebugVisible(true);
      window.hideDebugMarkers = () => setDebugVisible(false);
      setDebugVisible(true);
    </script>
    <script type="module" src="./royale-physics.js"></script>
  </body>
</html>
