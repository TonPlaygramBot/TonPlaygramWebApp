<!doctype html>
<html lang="sq">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Deluxe Billiards • 2.5D Cartoon (Portrait)</title>
    <style>
      /* ------------------------------------------------------------------
       DELUXE BILLIARDS 2.5D CARTOON (PORTRAIT)
       - Tavoline vertikale, kornize druri, 6 gropa korrekte (meset anesore).
       - Panel djathtas: SPIN siper, STEKA poshte (pull & release).
       - Steke mbi felt; zgjatje vizuale sipas fuqise.
       - Guida me pika qe shkallezohen me fuqine; rrotullim topash me "spin".
       - Palete ngjyrash reale, hije 2.5D.
       - Teste konsole per integritet – te ndihmojne te debug.
       ------------------------------------------------------------------ */

      * {
        box-sizing: border-box;
        touch-action: none;
      }

      html,
      body {
        margin: 0;
        height: 100%;
        background: #0b1120; /* blu e errete, si sallon bilardoje */
        color: #fff;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Ubuntu,
          Cantarell,
          'Helvetica Neue',
          Arial,
          'Noto Sans';
        overscroll-behavior: none;
      }

      #app {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
      }

      #header,
      #footer {
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        background: linear-gradient(#15203a, #0b1120);
      }

      #header {
        position: relative;
      }

      #header {
        border-bottom: 1px solid #24375f;
      }
      #footer {
        border-top: 1px solid #24375f;
        justify-content: center;
      }

      .player {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #fff;
        color: #222;
        display: grid;
        place-items: center;
        font-weight: 700;
        border: 2px solid #000;
      }

      .avatar.turn {
        box-shadow: 0 0 0 2px #facc15;
        border-color: #facc15;
      }

      .name {
        font-weight: 700;
      }

      .player .info {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .score {
        font-size: 18px;
        font-weight: 700;
        min-width: 32px;
        text-align: center;
      }

      .potted {
        display: flex;
        gap: 2px;
        margin-top: 2px;
      }

      .potted .ball {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        display: block;
      }

      #statusMsg {
        font-size: 12px;
        margin-top: 2px;
      }

      .foul {
        color: red;
      }

      #centerPopup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 32px;
        font-weight: 700;
        pointer-events: none;
        z-index: 200;
        display: none;
      }

      #centerPopup.foul {
        color: red;
        text-shadow: 2px 2px 0 #fff;
      }

      #centerPopup.shots {
        color: #fff;
        text-shadow: 2px 2px 0 #000;
      }

      #wrap {
        position: relative;
        flex: 1 1 auto;
        display: flex;
        overflow: hidden;
        /* Ensure background image covers the available space without
         overlapping top or bottom elements. Extend the width slightly
         so the thin green boundary line is fully visible while keeping
         extra clearance at the bottom. */
        background: url('/assets/icons/64e79228-35e3-4fdc-b914-fca635a40220.webp')
          top center/calc(100% + 8px) calc(100% + 24px) no-repeat;
      }

      :root {
        --rpw: min(23vw, 115px);
      }

      /* Canvas i tavolines (mbulon gjithcka, pervec panelit djathtas) */
      #table {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        transform: translateY(-4px);
        z-index: 4;
      }

      #cueHint {
        position: absolute;
        z-index: 7;
        display: none;
        font-size: 24px;
        pointer-events: none;
      }

      /* Paneli djathtas – SPIN siper, STEKA poshte */
      #rightPanel {
        position: absolute;
        top: 56px;
        right: 0;
        bottom: 56px;
        width: var(--rpw);

        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: flex-end;
        gap: 8px;
        padding: 12px 0 12px 8px;
        z-index: 10;
      }

      #spinBox {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #f6f6f6;
        position: absolute;
        left: 50%;
        top: 95%;
        transform: translate(-50%, -50%);
        box-shadow:
          0 4px 10px rgba(0, 0, 0, 0.4) inset,
          0 0 0 2px rgba(0, 0, 0, 0.15);
        transform-origin: center;
        z-index: 1;
      }

      #spinDot {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #e63; /* pika e kuqe */
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      #pullArea {
        position: relative;
        width: 110px;
        height: 67%;
        border-radius: 16px;
        background: none;
        box-shadow: none;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 9px;
        /* Allow the handle to overflow so only half of it is visible */
        overflow: visible;
        z-index: 7;
      }

      #cueRail {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 12px;
        height: calc(100% - 28px);
        background: none;
        border-radius: 9px;
        box-shadow: none;
      }

      #pullHandle {
        position: absolute;
        /* Position the pull button so that it's half outside the panel */
        left: calc(100% - 3px);
        transform: translate(-50%, -2px);
        width: 58px;
        height: 58px;
        border-radius: 50%;
        background: #fff;
        color: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
        padding-left: 1px;
        box-shadow: none;
        user-select: none;
        opacity: 1;
        visibility: visible;
        z-index: 8;
      }

      #powerBox {
        width: 12px;
        height: 23%;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 9px;
        position: relative;
        overflow: hidden;
        border: 2px solid #fff;
        box-shadow: none;
      }

      #powerFill {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 0%;
        background: #fff;
      }

      #powerCue {
        position: absolute;
        /* Align cue image with pull handle and power text along the right edge */
        left: calc(100% - 4px);
        top: 0;
        transform: translate(-50%, 0);
        transform-origin: top center;
        pointer-events: none;
        z-index: 6;
      }

      #powerTxt {
        margin-top: 9px;
        font-size: 15px;
        opacity: 0.85;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        text-align: right;
      }

      #play {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: #2b4f81;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 14px 28px;
        font-size: 16px;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
      }

      #play:hover {
        background: #3c67a3;
      }

      /* Removed the round shadow from the aiming line */
      #aimGlow {
        display: none;
      }

      .winnerOverlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.6);
        z-index: 60;
      }
      .winnerOverlay.hidden {
        display: none;
      }
      .winnerOverlay img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
      }
      .coin-confetti {
        position: fixed;
        top: -40px;
        width: 32px;
        height: 32px;
        pointer-events: none;
        animation: coin-fall var(--duration, 3s) linear forwards;
      }
      @keyframes coin-fall {
        from {
          transform: translateY(-10vh) rotate(0deg);
          opacity: 1;
        }
        to {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }

      .hidden {
        display: none;
      }

      #rulesBtn {
        position: fixed;
        left: 12px;
        bottom: 12px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        font-size: 18px;
        line-height: 28px;
        text-align: center;
        cursor: pointer;
        z-index: 80;
      }

      #rulesModal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 90;
        padding: 16px;
      }

      #rulesModal.hidden {
        display: none;
      }

      #rulesModal .rules-content {
        position: relative;
        background: #fff;
        color: #000;
        padding: 16px;
        border-radius: 8px;
        max-width: 90%;
        max-height: 80%;
        overflow-y: auto;
        line-height: 1.4;
      }

      #rulesModal h2 {
        margin-top: 0;
      }

      #closeRules {
        position: absolute;
        top: 8px;
        right: 8px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="header">
        <div class="player">
          <div class="avatar">A</div>
          <div class="score" id="p1Score">0</div>
          <div class="info">
            <div class="name">Artur</div>
            <div class="potted" id="p1Potted"></div>
          </div>
        </div>
        <div id="spinBox">
          <div id="spinDot"></div>
        </div>
        <div class="player">
          <div class="info">
            <div class="name">CPU</div>
            <div class="potted" id="p2Potted"></div>
          </div>
          <div class="score" id="p2Score">0</div>
          <div class="avatar">C</div>
        </div>
      </div>

      <div id="wrap">
        <canvas id="table"></canvas>
        <div id="cueHint">✋️</div>

        <!-- Panel djathtas: vetem slideri i fuqise -->
        <aside id="rightPanel">
          <div id="pullArea">
            <img
              id="powerCue"
              src="/assets/icons/file_0000000019d86243a2f7757076cd7869.webp"
              alt="Cue"
            />
            <div id="cueRail"></div>
            <div id="pullHandle">PULL</div>
          </div>

          <div
            style="
              display: flex;
              flex-direction: column;
              align-items: flex-end;
              gap: 6px;
            "
          >
            <div id="powerBox"><div id="powerFill"></div></div>
            <div id="powerTxt">
              <div>Power</div>
              <div id="powerPercent">0%</div>
            </div>
          </div>
        </aside>

        <button id="play">Play</button>
      </div>

      <div id="footer">
        <div id="turnPlayer" class="player">
          <div class="avatar"></div>
          <div class="info">
            <div class="name"></div>
            <div id="statusMsg"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="winnerOverlay" class="winnerOverlay hidden"></div>
    <div id="centerPopup"></div>

    <button id="rulesBtn" aria-label="Game rules">ℹ️</button>
    <div id="rulesModal" class="hidden" role="dialog" aria-modal="true">
      <div class="rules-content">
        <button id="closeRules" aria-label="Close">✖</button>
        <h2>8 Ball UK Rules</h2>
        <ul>
          <li>
            Rack with the black in the middle. A legal break pots a ball or
            drives two balls to cushions.
          </li>
          <li>
            Groups (red or yellow) are claimed by the first player to pot a ball
            after the break.
          </li>
          <li>
            On each shot hit one of your balls first and either pot a ball or
            make any ball reach a cushion.
          </li>
          <li>
            Fouls—such as potting the cue ball, striking the opponent's ball
            first or no cushion contact—give the opponent two visits.
          </li>
          <li>
            Clear your group then pot the black cleanly to win. Potting the
            black early or on a foul loses the frame.
          </li>
        </ul>
        <p class="rule-source">
          Rules based on World Eightball Pool Federation guidelines.
        </p>
      </div>
    </div>

    <script src="/flag-emojis.js"></script>

    <!--
    Shenim: Perdorim script me type="text/javascript" per te shmangur
    cdo interpretim si modul ose si gjuhe tjeter; kjo adreson gabimet e
    tipit "Unexpected token / (1:0)" ne disa rrethina.
  -->
    <script type="text/javascript">
      (function () {
        'use strict';

        document.addEventListener(
          'touchmove',
          function (e) {
            e.preventDefault();
          },
          { passive: false }
        );

        var params = new URLSearchParams(location.search);
        var variant = params.get('variant') || 'uk';
        var isAmerican = variant === 'american';
        var isNineBall = variant === '9ball';

        /* ==========================================================
       KONSTANTA TE LAYOUT-it DHE FIZIKES (sipas portrait)
       ========================================================= */
        var TABLE_W = 768; // gjeresi logjike e felt-it
        var TABLE_H = 1216; // lartesi logjike e felt-it
        var BORDER = 57; // korniza e drurit pak me e ngushte anash
        var POCKET_R = 42; // rrezja baze e gropave
        var BALL_R = 22.5; // rrezja baze e topave pak me e vogel
        var BORDER_TOP = BORDER + BALL_R * 2 - 4; // bordi i siperm pak me i holle per fushe me te gjate
        var BORDER_BOTTOM = BORDER; // anet e tjera mbeten te pandryshuara
        // Move the rack slightly upward on the table
        var SPOT_Y =
          BORDER_TOP +
          (TABLE_H - BORDER_TOP - BORDER_BOTTOM) * 0.25 -
          BALL_R * 0.5; // pika per trekendshin siper
        var LINE_Y = BORDER_TOP + (TABLE_H - BORDER_TOP - BORDER_BOTTOM) * 0.75; // vija e bardhe poshte
        var CUE_START_Y =
          LINE_Y + (TABLE_H - BORDER_BOTTOM - LINE_Y - BALL_R * 2) / 2; // pozicioni fillestar i cueball-it

        var FRICTION = 0.98; // ferkimi linear, pak me i madh per te ndalur me shpejt
        var BOUNCE = 0.98; // koeficienti i rikthimit

        var MIN_V = 0.12; // shpejtesia min. qe konsiderohet "ne levizje"

        /* ==========================================================
       ELEMENTET DOM
       ========================================================= */
        var canvas = document.getElementById('table');
        var ctx = canvas.getContext('2d');
        var rightPanel = document.getElementById('rightPanel');
        var playBtn = document.getElementById('play');
        var turnPlayer = document.getElementById('turnPlayer');
        var footerAvatar = turnPlayer.querySelector('.avatar');
        var footerName = turnPlayer.querySelector('.name');
        var statusMsg = document.getElementById('statusMsg');
        var footerTimeout = null;
        var centerPopup = document.getElementById('centerPopup');
        var spinBox = document.getElementById('spinBox');
        var spinDot = document.getElementById('spinDot');
        var logoImg = new Image();
        logoImg.src = '/assets/icons/pool-royale.svg';
        var cueImg = new Image();
        cueImg.src = '/assets/icons/file_0000000019d86243a2f7757076cd7869.webp';
        var pullArea = document.getElementById('pullArea');
        var pullHandle = document.getElementById('pullHandle');
        var powerFill = document.getElementById('powerFill');
        var powerTxt = document.getElementById('powerTxt');
        var powerPercent = document.getElementById('powerPercent');
        var powerCue = document.getElementById('powerCue');

        var avatarP1 = document.querySelector(
          '#header .player:first-child .avatar'
        );
        var nameP1 = document.querySelector(
          '#header .player:first-child .name'
        );
        var avatarCPU = document.querySelector(
          '#header .player:last-child .avatar'
        );
        var nameCPU = document.querySelector(
          '#header .player:last-child .name'
        );
        var pottedP1 = document.getElementById('p1Potted');
        var pottedP2 = document.getElementById('p2Potted');
        var scoreP1 = document.getElementById('p1Score');
        var scoreP2 = document.getElementById('p2Score');
        var cueHint = document.getElementById('cueHint');

        if (!isAmerican) {
          scoreP1.style.display = 'none';
          scoreP2.style.display = 'none';
        }

        var urlParams = new URLSearchParams(location.search);
        var avatarParam = urlParams.get('avatar');
        var nameParam = urlParams.get('name');
        if (nameParam) nameP1.textContent = nameParam;
        if (avatarParam) {
          avatarP1.style.backgroundImage = 'url(' + avatarParam + ')';
          avatarP1.style.backgroundSize = 'cover';
          avatarP1.textContent = '';
        }

        function coinConfetti(count, iconSrc) {
          count = count || 50;
          iconSrc = iconSrc || '/assets/icons/ezgif-54c96d8a9b9236.webp';
          for (var i = 0; i < count; i++) {
            var img = document.createElement('img');
            img.src = iconSrc;
            img.className = 'coin-confetti';
            img.style.left = Math.random() * 100 + 'vw';
            img.style.setProperty('--duration', 2 + Math.random() * 2 + 's');
            document.body.appendChild(img);
            setTimeout(
              (function (el) {
                return function () {
                  el.remove();
                };
              })(img),
              3000
            );
          }
        }

        function endGame(winner) {
          table.running = false;
          shotInProgress = false;
          var overlay = document.getElementById('winnerOverlay');
          var avatar = winner === 1 ? avatarP1 : avatarCPU;
          if (avatar) overlay.innerHTML = avatar.outerHTML;
          overlay.classList.remove('hidden');
          coinConfetti(50);
          setTimeout(function () {
            location.href =
              '/games/pollroyale/lobby?winner=' +
              winner +
              '&variant=' +
              variant;
          }, 2000);
        }

        // --------------------------------------------------
        // Audio setup
        // --------------------------------------------------
        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        var hitBuffer = null,
          pocketBuffer = null,
          knockBuffer = null;

        fetch('/assets/sounds/billiard-pool-hit-371618.mp3')
          .then(function (r) {
            return r.arrayBuffer();
          })
          .then(function (b) {
            return audioCtx.decodeAudioData(b);
          })
          .then(function (buf) {
            hitBuffer = buf;
          });

        fetch('/assets/sounds/billiard-sound-6-288417.mp3')
          .then(function (r) {
            return r.arrayBuffer();
          })
          .then(function (b) {
            return audioCtx.decodeAudioData(b);
          })
          .then(function (buf) {
            pocketBuffer = buf;
          });

        fetch('/assets/sounds/wooden-door-knock-102902.mp3')
          .then(function (r) {
            return r.arrayBuffer();
          })
          .then(function (b) {
            return audioCtx.decodeAudioData(b);
          })
          .then(function (buf) {
            knockBuffer = buf;
          });

        function playCueHit(vol) {
          audioCtx.resume();
          if (!hitBuffer) return;
          var src = audioCtx.createBufferSource();
          src.buffer = hitBuffer;
          var gain = audioCtx.createGain();
          gain.gain.value = clamp(vol, 0, 1);
          src.connect(gain).connect(audioCtx.destination);
          src.start(0, 0, 0.5);
        }

        function playBallHit(vol) {
          audioCtx.resume();
          if (!hitBuffer) return;
          var src = audioCtx.createBufferSource();
          src.buffer = hitBuffer;
          var gain = audioCtx.createGain();
          gain.gain.value = clamp(vol, 0, 1);
          src.connect(gain).connect(audioCtx.destination);
          src.start(0, 0.5, 0.5);
        }

        function playPocket(vol) {
          audioCtx.resume();
          if (!pocketBuffer) return;
          var src = audioCtx.createBufferSource();
          src.buffer = pocketBuffer;
          var gain = audioCtx.createGain();
          gain.gain.value = clamp(vol, 0, 1);
          src.connect(gain).connect(audioCtx.destination);
          var d = pocketBuffer.duration;
          src.start(0, Math.max(0, d - 1), 1);
        }

        function playTurnSound() {
          audioCtx.resume();
          if (!knockBuffer) return;
          var src = audioCtx.createBufferSource();
          src.buffer = knockBuffer;
          var gain = audioCtx.createGain();
          gain.gain.value = 1;
          src.connect(gain).connect(audioCtx.destination);
          src.start(0);
        }

        var tg = window.Telegram?.WebApp;
        var userData = tg?.initDataUnsafe?.user;
        if (userData) {
          if (!nameParam) {
            nameP1.textContent =
              [userData.first_name, userData.last_name]
                .filter(Boolean)
                .join(' ') || 'You';
          }
          if (!avatarParam) {
            if (userData.photo_url) {
              avatarP1.style.backgroundImage =
                'url(' + userData.photo_url + ')';
              avatarP1.style.backgroundSize = 'cover';
              avatarP1.textContent = '';
            } else if (userData.first_name) {
              avatarP1.textContent = userData.first_name.charAt(0);
            }
          }
          tg?.expand();
        }

        var regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
        function flagToName(flag) {
          try {
            var codes = Array.from(flag).map(function (c) {
              return c.codePointAt(0) - 0x1f1e6 + 65;
            });
            return regionNames.of(String.fromCharCode.apply(null, codes));
          } catch (e) {
            return 'AI';
          }
        }
        if (window.FLAG_EMOJIS) {
          var flag = FLAG_EMOJIS[(Math.random() * FLAG_EMOJIS.length) | 0];
          avatarCPU.textContent = flag;
          nameCPU.textContent = flagToName(flag) || 'CPU';
        }

        /* ==========================================================
       SHKALlEZIMI / RESIZE
       ========================================================= */
        var sX = 1,
          sY = 1,
          pocketR = POCKET_R,
          ballR = BALL_R;
        function resize() {
          var wrap = document.getElementById('wrap');
          var w = wrap.clientWidth;
          var h = wrap.clientHeight;
          var ar = TABLE_W / TABLE_H;
          var cw = w,
            ch = h;
          if (cw / ch > ar) cw = ch * ar;
          else ch = cw / ar;
          canvas.width = cw;
          canvas.height = ch;
          canvas.style.top = '0px';
          canvas.style.left = '0px';
          sX = cw / TABLE_W;
          sY = ch / TABLE_H;
          pocketR = POCKET_R * ((sX + sY) / 2);
          ballR = BALL_R * ((sX + sY) / 2);
          powerCue.style.height = BALL_R * 28 * sX + 'px';
          updatePullHandle();
        }
        window.addEventListener('resize', resize);

        /* ==========================================================
       UTILITARE
       ========================================================= */
        function clamp(v, a, b) {
          return Math.max(a, Math.min(b, v));
        }
        function len(x, y) {
          return Math.hypot(x, y);
        }
        function norm(x, y) {
          var L = len(x, y) || 1;
          return { x: x / L, y: y / L };
        }
        function d2(a, b) {
          var dx = a.x - b.x,
            dy = a.y - b.y;
          return dx * dx + dy * dy;
        }

        /* ==========================================================
       PALETA E NGJYRAVE DHE LISTA E TOPAVE
       ========================================================= */
        var COL, BALLS;
        if (isAmerican) {
          COL = {
            cue: '#f5f5f5',
            1: '#f5c400',
            2: '#2256ff',
            3: '#d92d30',
            4: '#7c3aed',
            5: '#ff8c1a',
            6: '#1faa4a',
            7: '#7a2f2f',
            8: '#111'
          };
          // BALLS – 0..15 — cdo element ka { n, t, c }
          BALLS = [
            { n: 0, t: 'cue', c: COL.cue },
            { n: 1, t: 'solid', c: COL[1] },
            { n: 2, t: 'solid', c: COL[2] },
            { n: 3, t: 'solid', c: COL[3] },
            { n: 4, t: 'solid', c: COL[4] },
            { n: 5, t: 'solid', c: COL[5] },
            { n: 6, t: 'solid', c: COL[6] },
            { n: 7, t: 'solid', c: COL[7] },
            { n: 8, t: 'eight', c: COL[8] },
            { n: 9, t: 'stripe', c: COL[1] },
            { n: 10, t: 'stripe', c: COL[2] },
            { n: 11, t: 'stripe', c: COL[3] },
            { n: 12, t: 'stripe', c: COL[4] },
            { n: 13, t: 'stripe', c: COL[5] },
            { n: 14, t: 'stripe', c: COL[6] },
            { n: 15, t: 'stripe', c: COL[7] }
          ];
        } else if (isNineBall) {
          COL = {
            cue: '#f5f5f5',
            1: '#f5c400',
            2: '#2256ff',
            3: '#d92d30',
            4: '#7c3aed',
            5: '#ff8c1a',
            6: '#1faa4a',
            7: '#7a2f2f',
            8: '#111',
            9: '#f5c400'
          };
          BALLS = [
            { n: 0, t: 'cue', c: COL.cue },
            { n: 1, t: 'solid', c: COL[1] },
            { n: 2, t: 'solid', c: COL[2] },
            { n: 3, t: 'solid', c: COL[3] },
            { n: 4, t: 'solid', c: COL[4] },
            { n: 5, t: 'solid', c: COL[5] },
            { n: 6, t: 'solid', c: COL[6] },
            { n: 7, t: 'solid', c: COL[7] },
            { n: 8, t: 'solid', c: COL[8] },
            { n: 9, t: 'stripe', c: COL[9] }
          ];
        } else {
          COL = {
            cue: '#f5f5f5',
            red: '#d92d30',
            yellow: '#f5c400',
            eight: '#111'
          };
          BALLS = [{ n: 0, t: 'cue', c: COL.cue }];
          for (var nn = 1; nn <= 7; nn++)
            BALLS.push({ n: nn, t: 'red', c: COL.red });
          BALLS.push({ n: 8, t: 'eight', c: COL.eight });
          for (var mm = 9; mm <= 15; mm++)
            BALLS.push({ n: mm, t: 'yellow', c: COL.yellow });
        }
        var TOTAL_BALLS = BALLS.length;

        // Map i sigurt sipas numrit → shmang akses jashte indekseve
        var BALL_BY_N = {};
        BALLS.forEach(function (b) {
          BALL_BY_N[b.n] = b;
        });

        /* ==========================================================
       KLASAT E ENTITETEVE
       ========================================================= */
        function Ball(info, x, y) {
          if (!info)
            throw new Error('Ball info undefined (nuk egziston ne BALLS)');
          this.n = info.n; // numri (0..15)
          this.t = info.t; // tipi (solid / stripe / eight / cue)
          this.c = info.c; // ngjyra
          this.p = { x: x, y: y }; // pozicioni
          this.v = { x: 0, y: 0 }; // shpejtesia
          this.pocketed = false; // ne grope
          this.a = 0; // kendi per vizualizim rrotullimi
          this.spin = { x: 0, y: 0 }; // spin aktiv
          this.spinApplied = false;
        }

        function Pocket(x, y) {
          this.x = x;
          this.y = y;
        }

        function Table() {
          this.balls = [];
          this.pockets = [];
          this.running = false;
          this.turn = 1; // 1: P1, 2: CPU
          this.captured = { 1: [], 2: [] };
          this.aim = { x: TABLE_W / 2, y: TABLE_H / 3 };
          this.reset();
        }

        Table.prototype.reset = function () {
          var i, j;
          this.balls = [];

          // Cue ball (center poshte vijes se bardhe)
          this.balls.push(new Ball(BALL_BY_N[0], TABLE_W / 2, CUE_START_Y));
          cueBallFree = true;
          aiming = false;
          cueHintTime = Date.now();

          // Trekendshi siper me 15 topa (8-shi ne qender rreshti 3)
          // Rrotulluar qe topi i verdhe te jete perballe cue ball-it
          var rowGap = BALL_R * 2.1;
          var colGap = BALL_R * 1.95;
          var cx = TABLE_W / 2;
          var cy = SPOT_Y - colGap * 2;

          if (isAmerican) {
            // Lista e numrave te tjere – do perdoren gradualisht
            var pool = [];
            for (i = 1; i <= 15; i++) {
              if (i !== 1 && i !== 2 && i !== 8 && i !== 11) pool.push(i);
            }
            var cursor = 0;

            // 5 rreshta nga lart poshte - trekendesh me maje poshte
            for (var r = 0; r < 5; r++) {
              var count = 5 - r;
              var startX = cx - (rowGap * (count - 1)) / 2;
              var y = cy + r * colGap;
              for (j = 0; j < count; j++) {
                var x = startX + j * rowGap;
                var num;
                if (r === 4 && j === 0)
                  num = 1; // yellow ne maje (poshte)
                else if (r === 2 && j === 1)
                  num = 8; // qender
                else if (r === 0 && j === 0)
                  num = 2; // qoshe solid majtas
                else if (r === 0 && j === 4)
                  num = 11; // qoshe stripe djathtas
                else num = pool[cursor++];
                var info = BALL_BY_N[num];
                if (!info) {
                  console.warn('Rack: numer i papercaktuar', num);
                  continue;
                }
                this.balls.push(new Ball(info, x, y));
              }
            }
          } else if (isNineBall) {
            // Rregullimi per 9-ball (diamant), i rrotulluar qe topi i verdhe te jete perballe cue ball-it
            var pattern9 = [
              [8],
              [7, 6],
              [5, 9, 4],
              [3, 2],
              [1]
            ];
            for (var r9 = 0; r9 < pattern9.length; r9++) {
              var cnt9 = pattern9[r9].length;
              var startX9 = cx - (rowGap * (cnt9 - 1)) / 2;
              var y9 = cy + r9 * colGap;
              for (var j9 = 0; j9 < cnt9; j9++) {
                var x9 = startX9 + j9 * rowGap;
                var num9 = pattern9[r9][j9];
                var info9 = BALL_BY_N[num9];
                if (!info9) {
                  console.warn('Rack: numer i papercaktuar', num9);
                  continue;
                }
                this.balls.push(new Ball(info9, x9, y9));
              }
            }
          } else {
            // Rregullimi standart per 8-ball UK (red & yellow)
            var pattern = [
              [9, 1, 10, 2, 11],
              [3, 12, 4, 13],
              [14, 8, 5],
              [15, 6],
              [7]
            ];
            for (var r2 = 0; r2 < pattern.length; r2++) {
              var cnt = pattern[r2].length;
              var startX2 = cx - (rowGap * (cnt - 1)) / 2;
              var y2 = cy + r2 * colGap;
              for (var j2 = 0; j2 < cnt; j2++) {
                var x2 = startX2 + j2 * rowGap;
                var num2 = pattern[r2][j2];
                var info2 = BALL_BY_N[num2];
                if (!info2) {
                  console.warn('Rack: numer i papercaktuar', num2);
                  continue;
                }
                this.balls.push(new Ball(info2, x2, y2));
              }
            }
          }

          // Pockets (4 qoshe + 2 te mesit anesore)
          this.pockets = [
            new Pocket(BORDER, BORDER_TOP),
            new Pocket(TABLE_W - BORDER, BORDER_TOP),
            new Pocket(BORDER, TABLE_H / 2 + BALL_R),
            new Pocket(TABLE_W - BORDER, TABLE_H / 2 + BALL_R),
            new Pocket(BORDER, TABLE_H - BORDER_BOTTOM),
            new Pocket(TABLE_W - BORDER, TABLE_H - BORDER_BOTTOM)
          ];

          this.captured = { 1: [], 2: [] };
          this.turn = 1;
          freeShots = { 1: 0, 2: 0 };
          firstHit = null;

          // TESTE TE INTEGRITETIT (console.assert)
          runSelfTests(this);
        };

        Table.prototype.isMoving = function () {
          for (var i = 0; i < this.balls.length; i++) {
            var b = this.balls[i];
            if (b.pocketed) continue;
            if (Math.abs(b.v.x) > MIN_V || Math.abs(b.v.y) > MIN_V) return true;
          }
          return false;
        };

        Table.prototype.update = function (dt) {
          var i, j;
          // Levizje + ferkim + kufij
          for (i = 0; i < this.balls.length; i++) {
            var b = this.balls[i];
            if (b.pocketed) continue;
            b.p.x += b.v.x * dt;
            b.p.y += b.v.y * dt;
            b.v.x *= FRICTION;
            b.v.y *= FRICTION;
            if (b.spin && b.spinApplied) {
              b.v.x += b.spin.x * 45 * dt;
              b.v.y += b.spin.y * 45 * dt;
              b.spin.x *= 0.98;
              b.spin.y *= 0.98;
            }
            b.a += (Math.hypot(b.v.x, b.v.y) * dt) / (BALL_R * 0.6);

            var L = BORDER + BALL_R;
            var R = TABLE_W - BORDER - BALL_R;
            var T = BORDER_TOP + BALL_R;
            var B = TABLE_H - BORDER_BOTTOM - BALL_R;
            if (b.p.x < L) {
              b.p.x = L;
              var sx = Math.abs(b.v.x);
              b.v.x *= -BOUNCE;
              if (b.n === 0) b.spinApplied = true;
              playCueHit(clamp(sx / 4000, 0, 1) * 0.5);
            }
            if (b.p.x > R) {
              b.p.x = R;
              var sx2 = Math.abs(b.v.x);
              b.v.x *= -BOUNCE;
              if (b.n === 0) b.spinApplied = true;
              playCueHit(clamp(sx2 / 4000, 0, 1) * 0.5);
            }
            if (b.p.y < T) {
              b.p.y = T;
              var sy = Math.abs(b.v.y);
              b.v.y *= -BOUNCE;
              if (b.n === 0) b.spinApplied = true;
              playCueHit(clamp(sy / 4000, 0, 1) * 0.5);
            }
            if (b.p.y > B) {
              b.p.y = B;
              var sy2 = Math.abs(b.v.y);
              b.v.y *= -BOUNCE;
              if (b.n === 0) b.spinApplied = true;
              playCueHit(clamp(sy2 / 4000, 0, 1) * 0.5);
            }
          }

          // Perplasje ball-ball
          var N = this.balls.length;
          for (i = 0; i < N; i++)
            for (j = i + 1; j < N; j++) {
              var a = this.balls[i],
                bb = this.balls[j];
              if (!a || !bb || a.pocketed || bb.pocketed) continue;
              var dx = bb.p.x - a.p.x,
                dy = bb.p.y - a.p.y,
                d = Math.hypot(dx, dy);
              if (d < BALL_R * 2) {
                var nx = dx / (d || 1),
                  ny = dy / (d || 1),
                  over = (BALL_R * 2 - d) / 2;
                a.p.x -= nx * over;
                a.p.y -= ny * over;
                bb.p.x += nx * over;
                bb.p.y += ny * over;
                var rvx = bb.v.x - a.v.x,
                  rvy = bb.v.y - a.v.y,
                  vn = rvx * nx + rvy * ny;
                if (vn < 0) {
                  var imp = -vn;
                  a.v.x -= imp * nx;
                  a.v.y -= imp * ny;
                  bb.v.x += imp * nx;
                  bb.v.y += imp * ny;
                  a.v.x *= BOUNCE;
                  a.v.y *= BOUNCE;
                  bb.v.x *= BOUNCE;
                  bb.v.y *= BOUNCE;
                  playBallHit(clamp(imp / 4000, 0, 1));
                  if (a.n === 0 || bb.n === 0) {
                    var other = a.n === 0 ? bb : a;
                    if (!firstHit) {
                      firstHit = BALL_BY_N[other.n];
                      if (
                        ((isAmerican || isNineBall) && other.n !== currentTarget) ||
                        (!isAmerican && !isNineBall &&
                          assignedTypes[currentShooter] &&
                          BALL_BY_N[other.n].t !==
                            assignedTypes[currentShooter])
                      ) {
                        if (!foulShown) {
                          showCenterPopup('Foul', 'foul', 1500);
                          foulShown = true;
                          var opponent = currentShooter === 1 ? 2 : 1;
                          updateFooter(
                            opponent,
                            isAmerican || isNineBall
                              ? 'Foul!'
                              : 'Foul – opponent gets two shots.'
                          );
                        }
                      }
                    }
                    if (a.n === 0) a.spinApplied = true;
                    if (bb.n === 0) bb.spinApplied = true;
                  }
                }
              }
            }

          // Kontroll i gropave
          for (i = 0; i < this.pockets.length; i++) {
            var p = this.pockets[i];
            for (j = 0; j < this.balls.length; j++) {
              var b2 = this.balls[j];
              if (b2.pocketed) continue;
              var ddx = b2.p.x - p.x,
                ddy = b2.p.y - p.y;
              if (Math.hypot(ddx, ddy) < POCKET_R * 0.9) {
                var spd = Math.hypot(b2.v.x, b2.v.y);
                playPocket(clamp(spd / 4000, 0, 1));
                if (b2.n === 0) {
                  scratch = true;
                  foulShown = true;
                  showCenterPopup('Foul', 'foul', 1500);
                  var opponent = currentShooter === 1 ? 2 : 1;
                  updateFooter(
                    opponent,
                    isAmerican || isNineBall
                      ? 'Foul!'
                      : 'Foul – opponent gets two shots.'
                  );
                  cueBallFree = true;
                  aiming = false;
                  cueHintTime = Date.now();
                  b2.p.x = TABLE_W / 2;
                  b2.p.y = CUE_START_Y;
                  b2.v.x = 0;
                  b2.v.y = 0;
                } else if (b2.n === 8 && !isAmerican && !isNineBall) {
                  b2.pocketed = true;
                  pocketedAny = true;
                  eightBallPotted = true;
                } else {
                  b2.pocketed = true;
                  pocketedAny = true;
                  this.captured[currentShooter].push(b2.n);
                  if (isNineBall && b2.n === 9) {
                    nineBallPotted = true;
                    lastPocketedBall = b2.n;
                    pottedThisShot.push(b2.n);
                    pocketedOwn = true;
                  } else if (isAmerican || isNineBall) {
                    pottedThisShot.push(b2.n);
                    pocketedOwn = true;
                    lastPocketedBall = b2.n;
                  } else {
                    var tType = BALL_BY_N[b2.n].t;
                    if (!assignedTypes[1] && tType !== 'eight') {
                      assignedTypes[currentShooter] = tType;
                      assignedTypes[currentShooter === 1 ? 2 : 1] =
                        tType === 'red' ? 'yellow' : 'red';
                      pocketedOwn = true;
                      updateFooter(
                        currentShooter,
                        'He sinks a ' + tType + ' and is now ' + tType + '.'
                      );
                    } else {
                      if (assignedTypes[currentShooter] === tType)
                        pocketedOwn = true;
                      updateFooter(currentShooter, 'He sinks a ' + tType + '.');
                    }
                    lastPocketedBall = b2.n;
                  }
                }
              }
            }
          }
        };

        Table.prototype.render = function () {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          // Field dimensions
          var x0 = BORDER * sX,
            y0 = BORDER_TOP * sY,
            w = (TABLE_W - 2 * BORDER) * sX,
            h = (TABLE_H - BORDER_TOP - BORDER_BOTTOM) * sY;

          // Vija kufizuese e cueball-it dhe pika qendrore
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x0, LINE_Y * sY);
          ctx.lineTo(x0 + w, LINE_Y * sY);
          ctx.stroke();
          ctx.fillStyle = '#fff';
          ctx.beginPath();
          ctx.arc(
            (TABLE_W / 2) * sX,
            SPOT_Y * sY,
            5 * ((sX + sY) / 2),
            0,
            Math.PI * 2
          );
          ctx.fill();
          // Topat
          for (var j = 0; j < this.balls.length; j++) {
            var b = this.balls[j];
            if (!b || b.pocketed) continue;
            var px = b.p.x * sX,
              py = b.p.y * sY;

            // hije eliptike 2.5D
            ctx.fillStyle = 'rgba(0,0,0,.35)';
            ctx.beginPath();
            ctx.ellipse(
              px,
              py + ballR * 0.35,
              ballR * 1.05,
              ballR * 0.45,
              0,
              0,
              Math.PI * 2
            );
            ctx.fill();

            // trup i topit
            ctx.save();
            ctx.translate(px, py);
            ctx.rotate(b.a);
            ctx.fillStyle = BALL_BY_N[b.n].c;
            ctx.beginPath();
            ctx.arc(0, 0, ballR, 0, Math.PI * 2);
            ctx.fill();

            // highlight
            var hl = ctx.createRadialGradient(
              -ballR * 0.4,
              -ballR * 0.4,
              2,
              -ballR * 0.4,
              -ballR * 0.4,
              ballR * 1.2
            );
            hl.addColorStop(0, 'rgba(255,255,255,.55)');
            hl.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = hl;
            ctx.beginPath();
            ctx.arc(0, 0, ballR, 0, Math.PI * 2);
            ctx.fill();

            // stripe nese duhet
            var stripe =
              BALL_BY_N[b.n].t === 'stripe' && (isAmerican || isNineBall);
            if (stripe) {
              ctx.save();
              ctx.beginPath();
              ctx.arc(0, 0, ballR, 0, Math.PI * 2);
              ctx.clip();
              ctx.fillStyle = '#fff';
              ctx.fillRect(-ballR, -ballR * 0.3, ballR * 2, ballR * 0.6);
              ctx.restore();
            }

            // numri (vetem per varianten amerikane ose per topin e zi)
            if (
              b.n !== 0 &&
              (isAmerican || isNineBall || BALL_BY_N[b.n].t === 'eight')
            ) {
              ctx.fillStyle = stripe ? BALL_BY_N[b.n].c : '#fff';
              ctx.beginPath();
              ctx.arc(0, 0, ballR * 0.52, 0, Math.PI * 2);
              ctx.fill();
              ctx.fillStyle = stripe ? '#fff' : '#111';
              ctx.font = ballR * 0.9 + 'px system-ui,sans-serif';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText(String(b.n), 0, 0);
            }

            // pika e spin-it te cue
            if (b.n === 0) {
              ctx.fillStyle = '#e63';
              ctx.beginPath();
              ctx.arc(
                spinVec.x * ballR * 0.75,
                spinVec.y * ballR * 0.75,
                ballR * 0.22,
                0,
                Math.PI * 2
              );
              ctx.fill();
            }
            ctx.restore();
          }

          // Steka mbi felt + guida
          if (!this.isMoving() && this.balls[0] && !this.balls[0].pocketed) {
            drawCueOnTable(this.balls[0].p, this.aim, cuePullVisual);
            if (showGuides) drawGuides(this.balls[0], this.aim);
          }
        };

        /* ==========================================================
       TESTE – kapin gabime si "undefined .n" heret
       ========================================================= */
        function runSelfTests(tbl) {
          // BALLS duhet te kete TOTAL_BALLS elemente
          console.assert(
            Array.isArray(BALLS) && BALLS.length === TOTAL_BALLS,
            'TEST FAIL: BALLS duhet ' + TOTAL_BALLS
          );
          for (var i = 0; i < BALLS.length; i++) {
            var it = BALLS[i];
            console.assert(
              typeof it.n === 'number' &&
                typeof it.t === 'string' &&
                typeof it.c === 'string',
              'TEST FAIL: item pa fusha',
              it
            );
          }
          // tavolina 16 topa (perfshi cue)
          console.assert(
            tbl.balls.length === TOTAL_BALLS,
            'TEST FAIL: tavolina ka',
            tbl.balls.length,
            'topa (duhet ' + TOTAL_BALLS + ')'
          );
          // asnje top undefined
          for (var j = 0; j < tbl.balls.length; j++) {
            var b = tbl.balls[j];
            console.assert(
              b && typeof b.n === 'number',
              'TEST FAIL: ball undefined ose pa n te index',
              j,
              b
            );
          }
          // 6 gropa
          console.assert(
            tbl.pockets.length === 6,
            'TEST FAIL: pockets',
            tbl.pockets.length
          );
          // vlera fillestare te aim/cue te vlefshme
          console.assert(
            typeof tbl.aim.x === 'number' && typeof tbl.aim.y === 'number',
            'TEST FAIL: aim i pavlefshem'
          );
        }

        /* ==========================================================
       GJENDJE GLOBALE E LOJES
       ========================================================= */
        var table = new Table();
        var last = 0; // koha e frame te fundit
        var aiming = false; // a po caktohet drejtimi
        var aimMoved = false; // a eshte levizur drejtimi gjate drag
        var showGuides = false; // a shfaqen pikat
        var cuePullVisual = 0; // shfaqje e terheqjes ne felt
        var spinVec = { x: 0, y: 0 }; // spini i zgjedhur
        var power = 0; // fuqi [0..1]
        var cueBallFree = true; // a mund te vendoset cueball
        var cueHintTime = Date.now();
        var draggingCue = false;
        var shotInProgress = false;
        var currentShooter = 1;
        var pocketedAny = false;
        var pocketedOwn = false;
        var scratch = false;
        var foulShown = false;
        var assignedTypes = { 1: null, 2: null };
        var freeShots = { 1: 0, 2: 0 };
        var firstHit = null;
        var lastTurn = table.turn;
        var cpuThinking = false;
        var scores = { 1: 0, 2: 0 };
        var lastPocketedBall = null;
        var currentTarget = null;
        var pottedThisShot = [];
        var eightBallPotted = false;
        var nineBallPotted = false;

        function remainingPoints() {
          var sum = 0;
          for (var i = 1; i < table.balls.length; i++) {
            var bb = table.balls[i];
            if (bb && !bb.pocketed) sum += bb.n;
          }
          return sum;
        }

        function checkGameOver() {
          if (!isAmerican) return;
          var rem = remainingPoints();
          if (scores[1] >= 100 || scores[1] > scores[2] + rem) {
            endGame(1);
          } else if (scores[2] >= 100 || scores[2] > scores[1] + rem) {
            endGame(2);
          } else if (rem === 0) {
            if (scores[1] === scores[2]) {
              table.captured[1] = table.captured[1].filter(function (n) {
                return n !== 8;
              });
              table.captured[2] = table.captured[2].filter(function (n) {
                return n !== 8;
              });
              table.balls.push(new Ball(BALL_BY_N[8], TABLE_W / 2, SPOT_Y));
              cueBallFree = true;
              cueHintTime = Date.now();
              var cue = table.balls[0];
              cue.p.x = TABLE_W / 2;
              cue.p.y = CUE_START_Y;
              cue.v.x = 0;
              cue.v.y = 0;
              updateCapturedUI();
              updateFooter(table.turn, 'Shoot the 8-ball to win!');
            } else {
              endGame(scores[1] > scores[2] ? 1 : 2);
            }
          }
        }

        function lowestBallOnTable() {
          var lowest = null;
          for (var i = 1; i < table.balls.length; i++) {
            var bb = table.balls[i];
            if (!bb || bb.pocketed || bb.n === 0) continue;
            if (lowest === null || bb.n < lowest) lowest = bb.n;
          }
          return lowest;
        }

        function createMiniBall(n) {
          var info = BALL_BY_N[n];
          var canv = document.createElement('canvas');
          canv.className = 'ball';
          canv.width = 20;
          canv.height = 20;
          var ctx = canv.getContext('2d');
          var r = 8,
            cx = 10,
            cy = 10;
          ctx.fillStyle = info.c;
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, Math.PI * 2);
          ctx.fill();
          var hl = ctx.createRadialGradient(
            cx - r * 0.4,
            cy - r * 0.4,
            2,
            cx - r * 0.4,
            cy - r * 0.4,
            r * 1.2
          );
          hl.addColorStop(0, 'rgba(255,255,255,.55)');
          hl.addColorStop(1, 'rgba(255,255,255,0)');
          ctx.fillStyle = hl;
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, Math.PI * 2);
          ctx.fill();
          var stripe = info.t === 'stripe' && (isAmerican || isNineBall);
          if (stripe) {
            ctx.save();
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.clip();
            ctx.fillStyle = '#fff';
            ctx.fillRect(cx - r, cy - r * 0.3, r * 2, r * 0.6);
            ctx.restore();
          }
          if (n !== 0 && (isAmerican || isNineBall || info.t === 'eight')) {
            ctx.fillStyle = stripe ? info.c : '#fff';
            ctx.beginPath();
            ctx.arc(cx, cy, r * 0.52, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = stripe ? '#fff' : '#111';
            ctx.font = '8px system-ui,sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(String(n), cx, cy);
          }
          return canv;
        }

        function updateCapturedUI() {
          function render(el, arr) {
            el.innerHTML = '';
            arr.forEach(function (n) {
              el.appendChild(createMiniBall(n));
            });
          }
          render(pottedP1, table.captured[1]);
          render(pottedP2, table.captured[2]);
        }

        function updateScoresUI() {
          scoreP1.textContent = scores[1];
          scoreP2.textContent = scores[2];
          checkGameOver();
        }
        if (isAmerican) updateScoresUI();

        function updateFooter(player, msg) {
          var srcAvatar = player === 1 ? avatarP1 : avatarCPU;
          footerAvatar.style.cssText = srcAvatar.style.cssText;
          footerAvatar.textContent = srcAvatar.textContent;
          footerName.textContent =
            player === 1 ? nameP1.textContent : nameCPU.textContent;
          statusMsg.innerHTML = msg || '';
          clearTimeout(footerTimeout);
          if (msg) {
            footerTimeout = setTimeout(function () {
              statusMsg.innerHTML = '';
            }, 1500);
          }
        }

        function showTurnInfo() {
          var msg;
          if (isAmerican || isNineBall) {
            if (!currentTarget) currentTarget = lowestBallOnTable();
            msg = 'Pot the ' + currentTarget + '-ball';
          } else {
            if (!assignedTypes[table.turn]) {
              msg = 'Choose a color';
            } else {
              msg = 'Pot a ' + assignedTypes[table.turn];
            }
          }
          updateFooter(table.turn, msg);
        }

        function updateTurnIndicator(force) {
          if (force || table.turn !== lastTurn) {
            avatarP1.classList.toggle('turn', table.turn === 1);
            avatarCPU.classList.toggle('turn', table.turn === 2);
            if (!force) playTurnSound();
            if (!force && freeShots[table.turn] > 1) {
              showCenterPopup('2 shots', 'shots', 1500);
            }
            lastTurn = table.turn;
          }
        }

        function updateCueHint() {
          var cue = table.balls[0];
          if (
            cueBallFree &&
            cue &&
            !cue.pocketed &&
            Date.now() - cueHintTime < 2000
          ) {
            cueHint.style.display = 'block';
            cueHint.style.left = cue.p.x * sX + ballR + 'px';
            cueHint.style.top = cue.p.y * sY - ballR * 2 + 'px';
          } else {
            cueHint.style.display = 'none';
          }
        }

        function showCenterPopup(text, cls, duration) {
          centerPopup.textContent = text;
          centerPopup.className = cls;
          centerPopup.style.display = 'block';
          setTimeout(function () {
            centerPopup.style.display = 'none';
          }, duration);
        }

        function isFoul(firstHit, scratch) {
          if (isAmerican || isNineBall) {
            return !firstHit || firstHit.n !== currentTarget || scratch;
          }
          if (!firstHit || scratch) return true;
          var shooterType = assignedTypes[currentShooter];
          function hasBallsLeft(type) {
            for (var k = 1; k < table.balls.length; k++) {
              var rb = table.balls[k];
              if (rb && !rb.pocketed && BALL_BY_N[rb.n].t === type) return true;
            }
            return false;
          }
          if (firstHit.t === 'eight') {
            return shooterType && hasBallsLeft(shooterType);
          }
          if (eightBallPotted && shooterType && hasBallsLeft(shooterType))
            return true;
          if (shooterType && firstHit.t !== shooterType) return true;
          return false;
        }

        function endShot() {
          shotInProgress = false;
          var opponent = currentShooter === 1 ? 2 : 1;
          var foul = isFoul(firstHit, scratch);
          var shotPoints = pottedThisShot.reduce(function (a, b) {
            return a + b;
          }, 0);
          if (foul) {
            if (isAmerican) {
              cueBallFree = true;
              if (shotPoints > 0) {
                scores[opponent] += shotPoints;
                updateScoresUI();
                updateFooter(
                  opponent,
                  'That\u2019s a foul – opponent gets ' + shotPoints + ' points.'
                );
                pottedThisShot.forEach(function (n) {
                  var arr = table.captured[currentShooter];
                  var idx = arr.indexOf(n);
                  if (idx !== -1) arr.splice(idx, 1);
                  table.captured[opponent].push(n);
                });
                updateCapturedUI();
              } else {
                var foulMsg = scratch
                  ? 'the cue ball went in'
                  : 'wrong first contact';
                updateFooter(opponent, 'That\u2019s a foul – ' + foulMsg + '.');
              }
            } else if (isNineBall) {
              cueBallFree = true;
              var foulMsg = scratch
                ? 'the cue ball went in'
                : 'wrong first contact';
              updateFooter(opponent, 'That\u2019s a foul – ' + foulMsg + '.');
            } else {
              updateFooter(opponent, 'Foul – opponent gets two shots.');
            }
            if (!foulShown) {
              showCenterPopup('Foul', 'foul', 1500);
              foulShown = true;
            }
            if (nineBallPotted) {
              endGame(opponent);
              return;
            }
            if (eightBallPotted) {
              endGame(opponent);
              return;
            }
            freeShots[opponent] = isAmerican || isNineBall ? 1 : 2;
            freeShots[currentShooter] = 0;
            table.turn = opponent;
            setTimeout(showTurnInfo, 1500);
          } else {
            if (nineBallPotted) {
              endGame(currentShooter);
              return;
            }
            if (eightBallPotted) {
              endGame(currentShooter);
              return;
            }
            if (shotPoints > 0 && isAmerican) {
              scores[currentShooter] += shotPoints;
              updateScoresUI();
            }
            if (freeShots[currentShooter] > 0) {
              freeShots[currentShooter]--;
              if (freeShots[currentShooter] === 0 && !pocketedOwn) {
                table.turn = opponent;
              }
            } else if (!pocketedOwn) {
              table.turn = opponent;
            }
            if (lastPocketedBall !== null) {
              var msg;
              if (isAmerican) {
                var total = scores[currentShooter];
                var closing = 100 - total;
                msg =
                  'He sinks the ' +
                  lastPocketedBall +
                  '-ball, that\u2019s ' +
                  lastPocketedBall +
                  ' points on the scoreboard.';
                if (total >= 63 && closing > 0) {
                  msg +=
                    ' Solid run — he\u2019s already at ' +
                    total +
                    ' points, just needs ' +
                    closing +
                    ' more to close the game.';
                }
              } else if (isNineBall) {
                msg = 'He sinks the ' + lastPocketedBall + '-ball.';
              } else {
                var col = BALL_BY_N[lastPocketedBall].t;
                msg = 'He sinks a ' + col + '.';
              }
              updateFooter(currentShooter, msg);
              lastPocketedBall = null;
              setTimeout(showTurnInfo, 1500);
            } else {
              updateFooter(
                table.turn,
                'Close call! The ball hit the cushion but nothing dropped, turn passes to the opponent.'
              );
              setTimeout(showTurnInfo, 1500);
            }
          }
          pottedThisShot = [];
          pocketedAny = false;
          pocketedOwn = false;
          scratch = false;
          foulShown = false;
          firstHit = null;
          currentTarget = null;
          eightBallPotted = false;
          nineBallPotted = false;
        }

        /* ==========================================================
       RENDER + UPDATE LOOP
       ========================================================= */
        function loop(t) {
          var dt = (t - last) / 1000 || 0;
          last = t;
          if (table.running) {
            table.update(Math.min(dt, 0.033));
            table.render();
            updateCapturedUI();
            updateCueHint();
            updateTurnIndicator();
            if (shotInProgress && !table.isMoving()) endShot();
            if (
              !table.isMoving() &&
              table.turn === 2 &&
              !shotInProgress &&
              !cpuThinking
            )
              setTimeout(cpuTurn, 200);
          }
          requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);
        updateTurnIndicator(true);
        showTurnInfo();

        /* ==========================================================
       INPUT – Aiming & Glow
       ========================================================= */
        function screenToTable(x, y) {
          var r = canvas.getBoundingClientRect();
          return {
            x: ((x - r.left) / r.width) * TABLE_W,
            y: ((y - r.top) / r.height) * TABLE_H
          };
        }

        canvas.addEventListener('pointerdown', function (e) {
          if (!table.running || table.isMoving()) return;
          var t = screenToTable(e.clientX, e.clientY);
          var cue = table.balls[0];
          var dist = Math.hypot(t.x - cue.p.x, t.y - cue.p.y);
          if (cueBallFree && dist <= BALL_R * 1.5) {
            draggingCue = true;
            cueHintTime = 0;
            cueHint.style.display = 'none';
            return;
          }
          aiming = true;
          aimMoved = false;
          showGuides = true;
        });

        canvas.addEventListener('pointermove', function (e) {
          var t = screenToTable(e.clientX, e.clientY);
          var cue = table.balls[0];
          if (draggingCue && cueBallFree) {
            var minX = BORDER + BALL_R,
              maxX = TABLE_W - BORDER - BALL_R;
            var minY = LINE_Y + BALL_R,
              maxY = TABLE_H - BORDER_BOTTOM - BALL_R;
            cue.p.x = clamp(t.x, minX, maxX);
            cue.p.y = clamp(t.y, minY, maxY);
            return;
          }
          if (!aiming || !table.running) return;
          table.aim = t;
          placeAimGlow(t);
          aimMoved = true;
        });

        canvas.addEventListener('pointerup', function () {
          if (draggingCue) {
            draggingCue = false;
            var cue = table.balls[0];
            table.aim = { x: cue.p.x, y: cue.p.y - BALL_R * 4 };
            showGuides = true;
            return;
          }
          aiming = false;
        });

        function placeAimGlow() {
          /* shadow removed */
        }

        /* ==========================================================
       GUIDES + CUE ON TABLE
       ========================================================= */
        function drawGuides(cue, aim) {
          var dx = aim.x - cue.p.x,
            dy = aim.y - cue.p.y;
          var L = len(dx, dy) || 1;
          var dir = { x: dx / L, y: dy / L };
          var step = BALL_R * 0.65,
            dots = 60;
          var x = cue.p.x,
            y = cue.p.y,
            target = null,
            hitStep = dots,
            railNormal = null;

          for (var i = 0; i < dots; i++) {
            x += dir.x * step;
            y += dir.y * step;
            if (x < BORDER + BALL_R) {
              railNormal = { x: 1, y: 0 };
            } else if (x > TABLE_W - BORDER - BALL_R) {
              railNormal = { x: -1, y: 0 };
            } else if (y < BORDER_TOP + BALL_R) {
              railNormal = { x: 0, y: 1 };
            } else if (y > TABLE_H - BORDER_BOTTOM - BALL_R) {
              railNormal = { x: 0, y: -1 };
            }
            if (railNormal) {
              // include the collision step so the guide reaches impact
              hitStep = i + 1;
              break;
            }
            for (var j = 0; j < table.balls.length; j++) {
              var b = table.balls[j];
              if (b === cue || b.pocketed) continue;
              if (d2({ x: x, y: y }, b.p) < BALL_R * 2.05 * (BALL_R * 2.05)) {
                target = b;
                // include the collision step so the guide reaches impact
                hitStep = i + 1;
                break;
              }
            }
            if (target) break;
          }

          ctx.fillStyle = target ? 'rgba(255,255,0,1)' : 'rgba(255,255,255,.7)';
          x = cue.p.x;
          y = cue.p.y;
          for (var i = 0; i < hitStep; i++) {
            x += dir.x * step;
            y += dir.y * step;
            if (
              x < BORDER + BALL_R ||
              x > TABLE_W - BORDER - BALL_R ||
              y < BORDER_TOP + BALL_R ||
              y > TABLE_H - BORDER_BOTTOM - BALL_R
            )
              break;
            ctx.beginPath();
            ctx.arc(x * sX, y * sY, 2, 0, Math.PI * 2);
            ctx.fill();
          }

          if (!target && railNormal) {
            var impactX = x,
              impactY = y;
            var dotIn = dir.x * railNormal.x + dir.y * railNormal.y;
            var refl = {
              x: dir.x - 2 * dotIn * railNormal.x,
              y: dir.y - 2 * dotIn * railNormal.y
            };
            ctx.save();
            ctx.strokeStyle = 'rgba(255,255,255,.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(impactX * sX, impactY * sY);
            ctx.lineTo(
              (impactX + refl.x * step * 10) * sX,
              (impactY + refl.y * step * 10) * sY
            );
            ctx.stroke();
            ctx.restore();
          }

          if (target) {
            var tx = target.p.x,
              ty = target.p.y;
            var impactCueX = cue.p.x + dir.x * step * hitStep;
            var impactCueY = cue.p.y + dir.y * step * hitStep;
            // Direction from cue ball to target ball at impact
            var hitN = { x: tx - impactCueX, y: ty - impactCueY };
            var nL = len(hitN.x, hitN.y) || 1;
            hitN.x /= nL;
            hitN.y /= nL;

            // Draw contact spot on the target ball
            var hitSpotX = tx - hitN.x * BALL_R;
            var hitSpotY = ty - hitN.y * BALL_R;
            ctx.save();
            ctx.fillStyle = 'rgba(255,255,255,.8)';
            ctx.beginPath();
            ctx.arc(
              hitSpotX * sX,
              hitSpotY * sY,
              BALL_R * 0.15,
              0,
              Math.PI * 2
            );
            ctx.fill();
            ctx.restore();

            // Project the target ball's path along the line of centers
            var tMax = Infinity;
            if (hitN.x > 0)
              tMax = Math.min(tMax, (TABLE_W - BORDER - BALL_R - tx) / hitN.x);
            if (hitN.x < 0)
              tMax = Math.min(tMax, (BORDER + BALL_R - tx) / hitN.x);
            if (hitN.y > 0)
              tMax = Math.min(
                tMax,
                (TABLE_H - BORDER_BOTTOM - BALL_R - ty) / hitN.y
              );
            if (hitN.y < 0)
              tMax = Math.min(tMax, (BORDER_TOP + BALL_R - ty) / hitN.y);
            var ex = tx + hitN.x * tMax;
            var ey = ty + hitN.y * tMax;

            ctx.save();
            ctx.strokeStyle = 'rgba(255,255,255,.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            // start the target path from the contact point so it connects with the aim line
            ctx.moveTo(hitSpotX * sX, hitSpotY * sY);
            ctx.lineTo(
              (ex - hitN.x * BALL_R) * sX,
              (ey - hitN.y * BALL_R) * sY
            );
            ctx.stroke();
            ctx.restore();

            // Calculate cue ball deflection direction
            var dot = dir.x * hitN.x + dir.y * hitN.y;
            var cbDir = { x: dir.x - hitN.x * dot, y: dir.y - hitN.y * dot };
            var cbL = len(cbDir.x, cbDir.y);
            if (cbL > 0.0001) {
              cbDir.x /= cbL;
              cbDir.y /= cbL;
              var cbEndX = impactCueX + cbDir.x * BALL_R * 4;
              var cbEndY = impactCueY + cbDir.y * BALL_R * 4;
              ctx.save();
              ctx.strokeStyle = 'rgba(255,255,255,.5)';
              ctx.lineWidth = 2;
              ctx.beginPath();
              ctx.moveTo(impactCueX * sX, impactCueY * sY);
              ctx.lineTo(cbEndX * sX, cbEndY * sY);
              ctx.stroke();
              ctx.restore();
            }
          }
        }

        function drawCueOnTable(cuePos, aim, pull) {
          // Align the cue with the guideline and pull it back based on the power slider
          var dx = aim.x - cuePos.x,
            dy = aim.y - cuePos.y;
          var len = Math.hypot(dx, dy) || 1;
          var dir = { x: dx / len, y: dy / len };
          var angle = Math.atan2(dir.y, dir.x) + Math.PI / 2;

          // Cue dimensions and offset to position the butt slightly lower
          var cueLength = BALL_R * 20;
          // Move cue image down by a little more than six ball diameters
          var cueShift = BALL_R * 2 * 6.3;

          if (cueImg.complete) {
            var scale = (cueLength * sX) / cueImg.width;
            var drawW = cueImg.width * scale;
            var drawH = cueImg.height * scale;
            var shiftPx = cueShift * sX;

            ctx.save();
            // Move origin away from the cue ball to simulate pullback
            ctx.translate(
              (cuePos.x - dir.x * pull) * sX,
              (cuePos.y - dir.y * pull) * sY
            );
            ctx.rotate(angle);
            // Offset the butt slightly downward
            ctx.translate(shiftPx, 0);
            ctx.drawImage(cueImg, -drawW / 2 - shiftPx, 0, drawW, drawH);
            ctx.restore();
          }
        }

        /* ==========================================================
       SPIN CONTROL – disk i bardhe me pike te kuqe
       ========================================================= */
        var spinTimer = null,
          spinMoved = false;
        function setSpin(nx, ny) {
          spinDot.style.left = 50 + nx * 50 + '%';
          spinDot.style.top = 50 + ny * 50 + '%';
          spinVec = { x: nx, y: ny };
        }
        setSpin(0, 0);
        function updateSpin(e) {
          var r = spinBox.getBoundingClientRect();
          var x = ((e.clientX - r.left) / r.width) * 2 - 1,
            y = ((e.clientY - r.top) / r.height) * 2 - 1;
          var L = Math.hypot(x, y);
          x = (x / (L || 1)) * Math.min(1, L);
          y = (y / (L || 1)) * Math.min(1, L);
          setSpin(x, y);
          spinMoved = true;
        }
        spinBox.addEventListener('pointerdown', function (e) {
          spinMoved = false;
          spinBox.style.transform = 'translate(-50%, -50%) scale(1.4)';
          clearTimeout(spinTimer);
          updateSpin(e);
          spinTimer = setTimeout(function () {
            if (!spinMoved)
              spinBox.style.transform = 'translate(-50%, -50%) scale(1)';
          }, 1500);
        });
        spinBox.addEventListener('pointermove', updateSpin);
        spinBox.addEventListener('pointerup', function () {
          clearTimeout(spinTimer);
          setTimeout(function () {
            spinBox.style.transform = 'translate(-50%, -50%) scale(1)';
          }, 50);
        });

        /* ==========================================================
       PULL & RELEASE – fuqi e goditjes
       ========================================================= */
        var pulling = false,
          pullMoved = false;
        function updatePullHandle() {
          var rect = pullArea.getBoundingClientRect();
          var minY = -pullHandle.offsetHeight * 0.6;
          var maxY = rect.height - pullHandle.offsetHeight * 0.4;
          var y = minY + (maxY - minY) * power;
          pullHandle.style.top = y + 'px';
          powerCue.style.top = y + pullHandle.offsetHeight + 10 + 'px';
        }
        function updatePowerUI() {
          powerFill.style.height = Math.round(power * 100) + '%';
          powerPercent.textContent = Math.round(power * 100) + '%';
          pullArea.style.background = 'none';
          updatePullHandle();
        }
        function updateFromEvent(e) {
          var rect = pullArea.getBoundingClientRect();
          power = clamp((e.clientY - rect.top) / rect.height, 0, 1);
          updatePowerUI();
          cuePullVisual = power * (BALL_R * 14);
          placeAimGlow(table.aim);
        }
        pullHandle.addEventListener('pointerdown', function (e) {
          if (!table.running || table.isMoving()) return;
          pulling = true;
          pullMoved = false;
          updateFromEvent(e);
        });
        pullArea.addEventListener('pointermove', function (e) {
          if (!pulling) return;
          pullMoved = true;
          updateFromEvent(e);
        });
        pullArea.addEventListener('pointerup', function () {
          if (!pulling) return;
          pulling = false;
          if (pullMoved) shoot(power);
          power = 0;
          updatePowerUI();
          cuePullVisual = 0;
        });

        updatePowerUI();

        function shoot(p) {
          if (!table.running || table.isMoving()) return;
          var cue = table.balls[0];
          if (!cue || cue.pocketed) return;
          var d = norm(table.aim.x - cue.p.x, table.aim.y - cue.p.y);
          var base = 950 * 3 * 1.6 * 1.5 * 0.75; // 25% reduced power
          playCueHit(p);
          currentShooter = table.turn;
          if (isAmerican || isNineBall) currentTarget = lowestBallOnTable();
          shotInProgress = true;
          pocketedAny = false;
          pocketedOwn = false;
          scratch = false;
          firstHit = null;
          pottedThisShot = [];
          eightBallPotted = false;
          nineBallPotted = false;
          cue.v.x = d.x * base * (0.25 + 0.75 * p);
          cue.v.y = d.y * base * (0.25 + 0.75 * p);
          // Increase the spin effect in all directions
          cue.spin = { x: spinVec.x * 45 * p, y: spinVec.y * 45 * p };
          cue.spinApplied = false;
          cueBallFree = false;
          setSpin(0, 0);
          showGuides = false;
        }

        /* ==========================================================
       CPU – turn i thjeshte (normal skill)
       ========================================================= */
        function cpuTurn() {
          if (table.isMoving() || table.turn !== 2) return;
          cpuThinking = true;
          var cue = table.balls[0];
          if (cueBallFree) {
            cue.p.x = TABLE_W / 2;
            cue.p.y = CUE_START_Y;
            cue.v.x = cue.v.y = 0;
          }
          var targets = [];
          if (isAmerican || isNineBall) {
            var lowest = null;
            for (var i = 0; i < table.balls.length; i++) {
              var b = table.balls[i];
              if (
                !b ||
                b.n === 0 ||
                b.pocketed ||
                (isAmerican && b.n === 8)
              )
                continue;
              if (!lowest || b.n < lowest.n) lowest = b;
            }
            if (lowest) targets.push(lowest);
          } else {
            var type = assignedTypes[2];
            for (var i = 0; i < table.balls.length; i++) {
              var b = table.balls[i];
              if (!b || b.n === 0 || b.pocketed || b.n === 8) continue;
              if (type && BALL_BY_N[b.n].t !== type) continue;
              targets.push(b);
            }
          }
          if (targets.length === 0) {
            table.turn = 1;
            cpuThinking = false;
            return;
          }

          function pathClear(contact, target) {
            var dir = norm(contact.x - cue.p.x, contact.y - cue.p.y);
            var dist = len(contact.x - cue.p.x, contact.y - cue.p.y);
            for (var j = 0; j < table.balls.length; j++) {
              var o = table.balls[j];
              if (!o || o === cue || o === target || o.pocketed) continue;
              var vx = o.p.x - cue.p.x,
                vy = o.p.y - cue.p.y;
              var proj = vx * dir.x + vy * dir.y;
              if (proj > 0 && proj < dist) {
                var px = cue.p.x + dir.x * proj,
                  py = cue.p.y + dir.y * proj;
                var off = Math.hypot(o.p.x - px, o.p.y - py);
                if (off < BALL_R * 2) return false;
              }
            }
            return true;
          }

          function pocketPathClear(ball, pocket) {
            var dir = norm(pocket.x - ball.p.x, pocket.y - ball.p.y);
            var dist = len(pocket.x - ball.p.x, pocket.y - ball.p.y);
            for (var j = 0; j < table.balls.length; j++) {
              var o = table.balls[j];
              if (!o || o === ball || o.pocketed) continue;
              var vx = o.p.x - ball.p.x,
                vy = o.p.y - ball.p.y;
              var proj = vx * dir.x + vy * dir.y;
              if (proj > 0 && proj < dist) {
                var px = ball.p.x + dir.x * proj,
                  py = ball.p.y + dir.y * proj;
                var off = Math.hypot(o.p.x - px, o.p.y - py);
                if (off < BALL_R * 2) return false;
              }
            }
            return true;
          }

          var best = null;
          for (var tIndex = 0; tIndex < targets.length; tIndex++) {
            var t = targets[tIndex];
            for (var pIndex = 0; pIndex < table.pockets.length; pIndex++) {
              var pk = table.pockets[pIndex];
              var toPocket = norm(pk.x - t.p.x, pk.y - t.p.y);
              var contact = {
                x: t.p.x - toPocket.x * BALL_R * 2,
                y: t.p.y - toPocket.y * BALL_R * 2
              };
              if (!pathClear(contact, t)) continue;
              if (!pocketPathClear(t, pk)) continue;
              var dist = len(contact.x - cue.p.x, contact.y - cue.p.y);
              if (!best || dist < best.dist) {
                best = {
                  nd: norm(contact.x - cue.p.x, contact.y - cue.p.y),
                  dist: dist,
                  target: t
                };
              }
            }
          }

          var nd, power, chosen;
          if (best) {
            nd = best.nd;
            power = 0.5;
            chosen = best.target;
          } else {
            chosen = targets[Math.floor(Math.random() * targets.length)];
            nd = norm(chosen.p.x - cue.p.x, chosen.p.y - cue.p.y);
            power = 0.35 + Math.random() * 0.3;
          }

          if (cueBallFree) {
            cue.p.x = clamp(
              chosen.p.x,
              BORDER + BALL_R * 2,
              TABLE_W - BORDER - BALL_R * 2
            );
            cue.p.y = CUE_START_Y;
            cue.v.x = cue.v.y = 0;
            cueBallFree = false;
            nd = norm(chosen.p.x - cue.p.x, chosen.p.y - cue.p.y);
          }

          // apply improved potting accuracy
          var ACCURACY = 0.95 + Math.random() * 0.03;
          nd = {
            x: nd.x + (Math.random() - 0.5) * (1 - ACCURACY),
            y: nd.y + (Math.random() - 0.5) * (1 - ACCURACY)
          };
          nd = norm(nd.x, nd.y);

          function nextTarget(exclude) {
            var type = assignedTypes[2];
            var bestBall = null,
              bestDist = Infinity;
            for (var i = 0; i < table.balls.length; i++) {
              var b = table.balls[i];
              if (!b || b === exclude || b.n === 0 || b.pocketed || b.n === 8)
                continue;
              if (type && BALL_BY_N[b.n].t !== type) continue;
              var d = len(b.p.x - exclude.p.x, b.p.y - exclude.p.y);
              if (d < bestDist) {
                bestDist = d;
                bestBall = b;
              }
            }
            return bestBall;
          }

          var spinX = 0,
            spinY = 0;
          var nxt = nextTarget(chosen);
          if (nxt) {
            var shotDir = norm(chosen.p.x - cue.p.x, chosen.p.y - cue.p.y);
            var toNext = norm(nxt.p.x - chosen.p.x, nxt.p.y - chosen.p.y);
            var dot = shotDir.x * toNext.x + shotDir.y * toNext.y;
            var cross = shotDir.x * toNext.y - shotDir.y * toNext.x;
            var SPIN_SCALE = 0.2;
            if (Math.abs(dot) > 0.75) spinY = SPIN_SCALE * dot;
            if (Math.abs(cross) > 0.25) spinX = SPIN_SCALE * cross;
          }

          table.aim = { x: cue.p.x + nd.x * 100, y: cue.p.y + nd.y * 100 };
          setSpin(spinX, spinY);
          cuePullVisual = power * (BALL_R * 14);
          showGuides = true;

          setTimeout(function () {
            cpuThinking = false;
            shoot(power);
            cuePullVisual = 0;
            showGuides = false;
          }, 800);
        }

        /* ==========================================================
       START / RESIZE / RENDER fillestar
       ========================================================= */
        playBtn.addEventListener('click', function () {
          playBtn.style.display = 'none';
          table.running = true;
          resize();
          table.render();
        });
        resize();
        table.render();
      })();
    </script>

    <script>
      const rulesBtn = document.getElementById('rulesBtn');
      const rulesModal = document.getElementById('rulesModal');
      const closeRules = document.getElementById('closeRules');

      rulesBtn.addEventListener('click', () => {
        rulesModal.classList.remove('hidden');
      });

      closeRules.addEventListener('click', () => {
        rulesModal.classList.add('hidden');
      });

      rulesModal.addEventListener('click', (e) => {
        if (e.target === rulesModal) {
          rulesModal.classList.add('hidden');
        }
      });
    </script>
  </body>
</html>
