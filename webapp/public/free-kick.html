<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Football Battle Royale</title>
  <style>
    :root{
      --bg:#0b1324;
      --panel:#0f172aee;
      --panel-border:#1f2a44;
      --accent:#22c55e;
      --accent-2:#38bdf8;
      --danger:#f97316;
      --joy-size:clamp(88px,24vw,128px);
      --joy-knob:clamp(52px,15vw,86px);
      --pad-gap:12px;
      --field:#0f8a2f;
      --field-dark:#0c7427;
      --chalk:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:#e2e8f0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overscroll-behavior:none}
    canvas{position:fixed;inset:0;width:100vw;height:100svh;display:block;touch-action:none;z-index:1}
    .hud{position:fixed;left:env(safe-area-inset-left,12px);right:env(safe-area-inset-right,12px);top:env(safe-area-inset-top,10px);display:grid;grid-template-columns:repeat(3,1fr);gap:10px;z-index:5}
    .panel{background:var(--panel);border:1px solid var(--panel-border);border-radius:14px;padding:10px 12px;backdrop-filter:blur(10px);display:flex;flex-direction:column;gap:4px}
    .label{font-size:12px;text-transform:uppercase;letter-spacing:.32px;color:#cbd5e1}
    .value{font-weight:800;font-size:18px}
    .center{text-align:center}
    .right{text-align:right}
    .controls{position:fixed;inset:0;pointer-events:none;z-index:10}
    .joy{position:absolute;width:var(--joy-size);height:var(--joy-size);border-radius:50%;background:rgba(0,0,0,.24);border:1px solid rgba(255,255,255,.16);left:env(safe-area-inset-left,14px);bottom:calc(env(safe-area-inset-bottom,10px) + 18px);touch-action:none;display:block;backdrop-filter:blur(10px);pointer-events:auto}
    .joy .knob{position:absolute;left:50%;top:50%;width:var(--joy-knob);height:var(--joy-knob);border-radius:50%;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.35);transform:translate(-50%,-50%);transition:background .15s ease}
    .pad{position:absolute;right:env(safe-area-inset-right,14px);bottom:calc(env(safe-area-inset-bottom,10px) + 18px);width:180px;height:180px;pointer-events:auto;display:grid;place-items:center}
    .pad-grid{position:relative;width:100%;height:100%}
    .actionBtn{position:absolute;width:70px;height:70px;border-radius:50%;border:1px solid rgba(255,255,255,.32);color:#fff;font-weight:800;letter-spacing:.4px;text-transform:uppercase;cursor:pointer;box-shadow:0 14px 28px rgba(0,0,0,.35);background:radial-gradient(circle at 50% 42%,rgba(34,197,94,1) 0 58%,rgba(12,105,55,.75) 82%,rgba(0,0,0,.35) 100%);transition:transform .12s ease, box-shadow .12s ease;font-size:11px}
    .actionBtn:active{transform:translateY(2px);box-shadow:0 10px 18px rgba(0,0,0,.28)}
    #btnUp{top:8px;left:50%;transform:translate(-50%,0)}
    #btnDown{bottom:8px;left:50%;transform:translate(-50%,0)}
    #btnLeft{left:6px;top:50%;transform:translate(0,-50%)}
    #btnRight{right:6px;top:50%;transform:translate(0,-50%)}
    #btnLeft{background:radial-gradient(circle at 50% 42%,rgba(56,189,248,1) 0 58%,rgba(30,94,135,.78) 82%,rgba(0,0,0,.35) 100%)}
    #btnRight{background:radial-gradient(circle at 50% 42%,rgba(248,113,113,1) 0 58%,rgba(153,27,27,.78) 82%,rgba(0,0,0,.38) 100%)}
    #btnDown{background:radial-gradient(circle at 50% 42%,rgba(249,115,22,1) 0 58%,rgba(154,52,18,.78) 82%,rgba(0,0,0,.38) 100%)}
    .message{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,10px) + 210px);transform:translateX(-50%);background:rgba(15,23,42,.8);border:1px solid var(--panel-border);border-radius:14px;padding:10px 14px;backdrop-filter:blur(10px);z-index:8;min-width:200px;text-align:center;font-weight:700}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65);color:#fff;z-index:20}
    .overlay.hidden{display:none}
    .card{background:rgba(15,23,42,.95);padding:18px;border-radius:16px;border:1px solid rgba(255,255,255,.14);box-shadow:0 18px 38px rgba(0,0,0,.45);text-align:center;max-width:320px;width:92%}
    .card button{margin-top:12px;border:0;border-radius:12px;padding:10px 14px;font-weight:800;letter-spacing:.4px;background:var(--accent);color:#fff;cursor:pointer;width:100%}
  </style>
</head>
<body>
  <canvas id="game" aria-label="Football Battle Royale"></canvas>
  <div class="hud">
    <div class="panel">
      <div class="label">Ndeshja</div>
      <div class="value">Football Battle Royale</div>
    </div>
    <div class="panel center">
      <div class="label">Koha</div>
      <div class="value" id="time">02:00</div>
    </div>
    <div class="panel right">
      <div class="label">Rezultati</div>
      <div class="value" id="score">0 - 0</div>
    </div>
  </div>
  <div class="controls">
    <div id="joystick" class="joy">
      <div class="knob"></div>
    </div>
    <div class="pad">
      <div class="pad-grid">
        <button id="btnUp" class="actionBtn">Shoot</button>
        <button id="btnDown" class="actionBtn">Dash</button>
        <button id="btnLeft" class="actionBtn">Pass</button>
        <button id="btnRight" class="actionBtn">Tackle</button>
      </div>
    </div>
  </div>
  <div class="message" id="message">Lëvize me joystick dhe përdor butonat për aksione.</div>
  <div class="overlay hidden" id="overlay">
    <div class="card">
      <h3>Koha përfundoi</h3>
      <p id="finalScore">Rezultati: 0 - 0</p>
      <button id="restart">Luaj përsëri</button>
    </div>
  </div>
  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let W = window.innerWidth; let H = window.innerHeight;
    const DPR = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
    const field = { w: 120, h: 68 };
    const goalWidth = 7.32;
    const goalDepth = 3;
    const players = [];
    const teams = { home: { color:'#38bdf8', score:0 }, away:{ color:'#f87171', score:0 } };
    const maxPlayers = 6;
    const joystick = document.getElementById('joystick');
    const knob = joystick.querySelector('.knob');
    const messageEl = document.getElementById('message');
    const timeEl = document.getElementById('time');
    const scoreEl = document.getElementById('score');
    const overlay = document.getElementById('overlay');
    const finalScore = document.getElementById('finalScore');
    const restartBtn = document.getElementById('restart');
    const audio = {
      crowd: new Audio('/assets/sounds/football-crowd-3-69245.mp3'),
      kick: new Audio('/assets/sounds/ball kick .mp3'),
      goal: new Audio('/assets/sounds/a-football-hits-the-net-goal-313216.mp3')
    };
    audio.crowd.loop = true; audio.crowd.volume = 0.35;
    audio.goal.volume = 1; audio.kick.volume = 0.75;

    const ball = { x:0, y:0, vx:0, vy:0, r:1, carrier:null };
    let activePlayer = null;
    let joystickState = { active:false, dx:0, dy:0 };
    let sprintTimer = 0;
    let remaining = 120;
    let lastTime = performance.now();
    let running = true;

    function resize(){
      W = window.innerWidth; H = window.innerHeight;
      canvas.width = Math.floor(W * DPR);
      canvas.height = Math.floor(H * DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0);
    }
    resize();
    window.addEventListener('resize', resize);

    function createTeams(){
      players.length = 0;
      for(let i=0;i<maxPlayers;i++){
        const t = i % 2 === 0 ? 'home' : 'away';
        const side = t === 'home' ? -1 : 1;
        const px = side * (field.w*0.25 + Math.random()*6);
        const py = (Math.random()-0.5) * (field.h*0.6);
        players.push({ team:t, x:px, y:py, vx:0, vy:0, speed:9, hasBall:false });
      }
      ball.x = 0; ball.y = 0; ball.vx=0; ball.vy=0; ball.carrier=null;
      teams.home.score = 0; teams.away.score = 0;
    }

    function drawField(){
      ctx.fillStyle = '#0a8a2d';
      ctx.fillRect(0,0,W,H);
      const scale = Math.min(W/field.w, H/field.h);
      const offsetX = W/2 - (field.w*scale)/2;
      const offsetY = H/2 - (field.h*scale)/2;
      ctx.save();
      ctx.translate(offsetX, offsetY);
      ctx.scale(scale, scale);
      for(let x = -field.w/2; x < field.w/2; x += 7){
        ctx.fillStyle = (Math.floor(x/7)%2===0)?'rgba(255,255,255,0.02)':'rgba(0,0,0,0.04)';
        ctx.fillRect(x, -field.h/2, 7, field.h);
      }
      ctx.strokeStyle = 'rgba(255,255,255,0.8)';
      ctx.lineWidth = 0.3;
      ctx.strokeRect(-field.w/2, -field.h/2, field.w, field.h);
      ctx.beginPath();
      ctx.arc(0,0,9.15,0,Math.PI*2);
      ctx.moveTo(0,-field.h/2);
      ctx.lineTo(0,field.h/2);
      ctx.stroke();
      drawGoal(-field.w/2, -goalWidth/2);
      drawGoal(field.w/2 - goalDepth, -goalWidth/2);

      const drawPlayer = (p,isActive) => {
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.fillStyle = teams[p.team].color;
        ctx.beginPath();
        ctx.arc(0,0,1.1,0,Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = isActive ? '#fff' : 'rgba(255,255,255,0.45)';
        ctx.lineWidth = isActive ? 0.24 : 0.18;
        ctx.stroke();
        if(p.hasBall){
          ctx.beginPath();
          ctx.arc(0,-1.7,0.4,0,Math.PI*2);
          ctx.fillStyle='#fff';
          ctx.fill();
        }
        ctx.restore();
      };
      players.forEach((p)=> drawPlayer(p, p===activePlayer));

      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    function drawGoal(x, y){
      ctx.save();
      ctx.translate(x, y);
      ctx.strokeStyle = 'rgba(255,255,255,0.8)';
      ctx.lineWidth = 0.35;
      ctx.strokeRect(0,0,goalDepth, goalWidth);
      ctx.restore();
    }

    function clamp(val,min,max){ return Math.max(min, Math.min(max,val)); }

    function update(dt){
      if(!running) return;
      remaining = Math.max(0, remaining - dt);
      if(remaining === 0){ endMatch(); }
      if(sprintTimer>0){ sprintTimer = Math.max(0, sprintTimer - dt); }

      const speed = 8 + (sprintTimer>0?4:0);
      if(activePlayer){
        activePlayer.vx += joystickState.dx * speed * dt;
        activePlayer.vy += joystickState.dy * speed * dt;
      }

      players.forEach((p)=>{
        p.vx *= 0.9; p.vy *= 0.9;
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        p.x = clamp(p.x, -field.w/2 + 1.5, field.w/2 - 1.5);
        p.y = clamp(p.y, -field.h/2 + 1.5, field.h/2 - 1.5);
      });

      resolveAI(dt);
      autoSwitchPlayer();
      resolvePossession();
      updateBall(dt);
      updateScoreboard();
    }

    function autoSwitchPlayer(){
      let best = null; let bestDist = Infinity;
      players.filter(p=>p.team==='home').forEach((p)=>{
        const d = Math.hypot(p.x - ball.x, p.y - ball.y);
        if(d < bestDist){ bestDist = d; best = p; }
      });
      activePlayer = best;
    }

    function resolvePossession(){
      if(ball.carrier){
        ball.x = ball.carrier.x; ball.y = ball.carrier.y - 0.2;
        return;
      }
      players.forEach((p)=>{
        const dist = Math.hypot(p.x - ball.x, p.y - ball.y);
        if(dist < 1.3){
          ball.carrier = p;
          p.hasBall = true;
          ball.vx = ball.vy = 0;
        }
      });
    }

    function updateBall(dt){
      if(ball.carrier) return;
      ball.x += ball.vx * dt;
      ball.y += ball.vy * dt;
      ball.vx *= 0.98; ball.vy *= 0.98;
      if(Math.hypot(ball.vx, ball.vy) < 0.1){ ball.vx = ball.vy = 0; }
      if(ball.x < -field.w/2){
        if(ball.y > -goalWidth/2 && ball.y < goalWidth/2){ scoreGoal('away'); }
        ball.x = -field.w/2 + 0.5; ball.vx *= -0.5;
      }
      if(ball.x > field.w/2){
        if(ball.y > -goalWidth/2 && ball.y < goalWidth/2){ scoreGoal('home'); }
        ball.x = field.w/2 - 0.5; ball.vx *= -0.5;
      }
      if(ball.y < -field.h/2 || ball.y > field.h/2){ ball.y = clamp(ball.y, -field.h/2, field.h/2); ball.vy *= -0.6; }
    }

    function shoot(){
      if(!activePlayer || ball.carrier !== activePlayer) return showHint('Duhet ta zotërosh topin për të gjuajtur.');
      const dir = activePlayer.team === 'home' ? 1 : -1;
      const targetY = clamp((Math.random()-0.5)*goalWidth*0.8, -goalWidth/2, goalWidth/2);
      const speed = 26;
      ball.carrier.hasBall=false; ball.carrier=null;
      ball.vx = dir*speed; ball.vy = (targetY - activePlayer.y)*1.2;
      audio.kick.currentTime=0; audio.kick.play().catch(()=>{});
      showHint('Goditje drejt portës!');
    }

    function passBall(){
      if(!activePlayer || ball.carrier !== activePlayer) return showHint('Kontrollo topin për të pasuar.');
      const mates = players.filter(p=>p.team===activePlayer.team && p!==activePlayer);
      let target = mates[0]; let best = Infinity;
      mates.forEach((m)=>{ const d=Math.hypot(m.x-activePlayer.x,m.y-activePlayer.y); if(d<best){best=d;target=m;} });
      if(!target) return;
      const speed = 18;
      const dx = target.x - activePlayer.x;
      const dy = target.y - activePlayer.y;
      const len = Math.hypot(dx,dy) || 1;
      ball.carrier.hasBall=false; ball.carrier=null;
      ball.vx = (dx/len)*speed; ball.vy = (dy/len)*speed;
      audio.kick.currentTime=0; audio.kick.play().catch(()=>{});
      showHint('Pasim i shpejtë.');
    }

    function tackle(){
      if(!activePlayer) return;
      const opponents = players.filter(p=>p.team!==activePlayer?.team);
      const victim = opponents.find(o=>Math.hypot(o.x-activePlayer.x,o.y-activePlayer.y) < 2 && o.hasBall);
      if(victim){
        victim.hasBall=false; ball.carrier=victim; victim.vx*=0.2; victim.vy*=0.2;
        victim.hasBall=false; ball.carrier=null; ball.x=victim.x; ball.y=victim.y; ball.vx=0; ball.vy=0;
        activePlayer.hasBall=true; ball.carrier=activePlayer;
        showHint('Topi u rikuperua!');
      } else {
        showHint('Asnjë kundërshtar pranë për t’u ndalur.');
      }
    }

    function dash(){
      sprintTimer = 1.0;
      showHint('Sprint aktiv për pak sekonda.');
    }

    function scoreGoal(team){
      teams[team].score += 1;
      ball.carrier=null; players.forEach(p=>p.hasBall=false);
      ball.x = team==='home' ? -field.w*0.25 : field.w*0.25;
      ball.y = 0; ball.vx=0; ball.vy=0;
      audio.goal.currentTime=0; audio.goal.play().catch(()=>{});
      showHint(team==='home' ? 'Gol për ekipin tonë!' : 'Kundërshtarët shënuan.');
    }

    function updateScoreboard(){
      timeEl.textContent = formatTime(Math.max(0,Math.floor(remaining)));
      scoreEl.textContent = `${teams.home.score} - ${teams.away.score}`;
    }

    function formatTime(sec){
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = Math.floor(sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function showHint(text){
      messageEl.textContent = text;
      messageEl.style.opacity = 1;
      clearTimeout(showHint._t);
      showHint._t = setTimeout(()=>{ messageEl.style.opacity = 0.9; }, 800);
    }

    function endMatch(){
      running = false;
      overlay.classList.remove('hidden');
      finalScore.textContent = `Rezultati: ${teams.home.score} - ${teams.away.score}`;
      try{ audio.crowd.pause(); }catch{}
    }

    restartBtn.addEventListener('click', ()=>{
      overlay.classList.add('hidden');
      remaining = 120; running=true; sprintTimer=0;
      createTeams();
      updateScoreboard();
      audio.crowd.currentTime=0; audio.crowd.play().catch(()=>{});
      lastTime = performance.now();
      requestAnimationFrame(loop);
    });

    function loop(now){
      const dt = Math.min(0.05, (now - lastTime)/1000);
      lastTime = now;
      update(dt);
      drawField();
      requestAnimationFrame(loop);
    }

    function startJoystick(){
      let pointer = null;
      const rect = () => joystick.getBoundingClientRect();
      const update = (clientX, clientY) => {
        const r = rect();
        const cx = r.left + r.width/2;
        const cy = r.top + r.height/2;
        const dx = clientX - cx;
        const dy = clientY - cy;
        const radius = r.width/2;
        const mag = Math.min(Math.hypot(dx,dy), radius);
        const nx = dx / radius;
        const ny = dy / radius;
        joystickState = { active:true, dx:nx, dy:ny };
        knob.style.left = `${50 + (mag/radius)*nx*50}%`;
        knob.style.top = `${50 + (mag/radius)*ny*50}%`;
      };
      const reset = () => {
        pointer=null; joystickState={active:false,dx:0,dy:0}; knob.style.left='50%'; knob.style.top='50%';
      };
      joystick.addEventListener('pointerdown',(e)=>{ pointer=e.pointerId; joystick.setPointerCapture(e.pointerId); update(e.clientX,e.clientY); });
      joystick.addEventListener('pointermove',(e)=>{ if(pointer===e.pointerId) update(e.clientX,e.clientY); });
      const end = (e)=>{ if(pointer===e.pointerId){ reset(); } };
      joystick.addEventListener('pointerup',end); joystick.addEventListener('pointercancel',end); joystick.addEventListener('pointerleave',end);
    }

    function bindButtons(){
      document.getElementById('btnUp').addEventListener('pointerdown', shoot);
      document.getElementById('btnLeft').addEventListener('pointerdown', passBall);
      document.getElementById('btnRight').addEventListener('pointerdown', tackle);
      document.getElementById('btnDown').addEventListener('pointerdown', dash);
    }

    function resolveAI(dt){
      players.filter(p=>p.team==='away').forEach((bot)=>{
        const target = ball.carrier && ball.carrier.team==='away' ? (bot===ball.carrier?null:ball.carrier) : ball;
        if(!target) return;
        const dx = target.x - bot.x;
        const dy = target.y - bot.y;
        const len = Math.hypot(dx,dy)||1;
        const speed = 7;
        bot.vx += (dx/len)*speed*dt;
        bot.vy += (dy/len)*speed*dt;
        if(target===ball && Math.hypot(dx,dy)<1.6){
          ball.carrier = bot; bot.hasBall=true; ball.vx=0; ball.vy=0;
          const towardsGoal = bot.team==='away'? -1:1;
          ball.carrier=null; bot.hasBall=false;
          ball.vx = towardsGoal*18; ball.vy = (Math.random()-0.5)*8;
        }
      });
    }

    function init(){
      createTeams();
      startJoystick();
      bindButtons();
      updateScoreboard();
      audio.crowd.play().catch(()=>{});
      requestAnimationFrame(loop);
    }

    init();
  </script>
</body>
</html>
