<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>TonPlaygram â€” Slingshot Royale (Max HTML)</title>
<style>
  :root{ --bg:#0b1022; --bg2:#101a3f; --stroke:#1e2a56; --text:#e7eefc; --muted:#a9b6ea; --gold:#ffd273; --primary:#2563eb; }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background:radial-gradient(1100px 740px at 70% -10%, #1c2c6e 0%, var(--bg2) 36%, var(--bg) 100%) fixed;
  }
  .app{height:100%;max-width:1120px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  header h1{margin:0;font-size:18px}
  .badge{background:#0f1736;border:1px solid var(--stroke);border-radius:10px;padding:6px 10px;color:#b7c4ef;font-size:12px}
  .right{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  select,input{background:#0e1430;color:var(--text);border:1px solid var(--stroke);border-radius:10px;padding:8px 10px}
  .btn{background:linear-gradient(180deg,#2a6cf0,#2156c8);border:none;border-radius:10px;padding:8px 12px;color:#fff;font-weight:700;cursor:pointer}
  .ghost{background:#0f1736;border:1px solid var(--stroke);color:#cfe1ff}

  .hud{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .tile{background:linear-gradient(180deg,#0f1530,#0c132b);border:1px solid var(--stroke);border-radius:14px;padding:10px 12px;text-align:center}
  .tile .k{color:#cbd6ff}
  .tile .v{font-size:22px;font-weight:800}
  .score{color:var(--gold)}

  .row-top{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .card{background:linear-gradient(180deg,#0f1530,#0c132b);border:1px solid var(--stroke);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:6px}
  .card h3{margin:0 0 2px 0;font-size:14px;color:#cfe1ff;display:flex;align-items:center;gap:8px}
  .miniStat{font-size:12px;color:var(--muted)}
  .mini{width:100%;aspect-ratio:1/1;border-radius:10px;background:#0b1438;display:block}
  .flagInline{width:16px;height:16px;border-radius:2px}

  .stage{flex:1;min-height:0;background:linear-gradient(180deg,#0f1530,#0c132b);border:1px solid var(--stroke);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .stage h3{margin:0 0 4px 0;font-size:14px;color:#a9b6ea}
  #userCanvas{flex:1;width:100%;height:100%;background:#0b1438;border-radius:12px;touch-action:none}
  .hint{font-size:12px;color:#b6c4f4}
  .userHeader{display:flex;align-items:center;gap:8px}
  .avatar{width:32px;height:32px;border-radius:50%}

  /* Results overlay (no <dialog>) */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,8,20,0.6);backdrop-filter:blur(2px)}
  .modal{width:min(520px, calc(100% - 24px));background:linear-gradient(180deg,#0f1736,#0b1126);border:1px solid var(--stroke);border-radius:16px;padding:14px}
  .modal h2{margin:0 0 10px 0}
  .grid{display:grid;gap:10px}
  .two{grid-template-columns:1fr 1fr}
  .kpi{background:#0b1228;border:1px solid var(--stroke);border-radius:12px;padding:10px;text-align:center}
  .kpi .v{font-size:22px;font-weight:800}
  .row-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>TonPlaygram</h1><span class="badge">Slingshot Royale â€¢ HTMLâ€‘only</span>
    <div class="right">
      <select id="players">
        <option value="2">2 players</option>
        <option value="3">3 players</option>
        <option value="4" selected>4 players</option>
      </select>
      <select id="duration">
        <option value="60">1:00</option>
        <option value="180" selected>3:00</option>
        <option value="300">5:00</option>
      </select>
      <input id="stake" type="number" min="0" step="50" value="300" style="width:110px" />
      <button id="start" class="btn">Start</button>
      <button id="mute" class="ghost" title="Toggle sound">ðŸ”‡</button>
    </div>
  </header>

  <div class="hud">
    <div class="tile"><div class="k">Status</div><div id="status" class="v">Ready</div></div>
    <div class="tile"><div class="k">Time</div><div id="time" class="v">03:00</div></div>
    <div class="tile"><div class="k">Pot (TPC)</div><div id="pot" class="v score">0</div></div>
  </div>

  <div class="row-top">
    <div class="card"><h3><img id="avatar1" src="assets/icons/profile.svg" alt="" class="flagInline"/><span id="name1">P1</span></h3><div class="miniStat" id="s1">0</div><canvas id="opp1" class="mini"></canvas></div>
    <div class="card"><h3><img id="avatar2" src="assets/icons/profile.svg" alt="" class="flagInline"/><span id="name2">P2</span></h3><div class="miniStat" id="s2">0</div><canvas id="opp2" class="mini"></canvas></div>
    <div class="card"><h3><img id="avatar3" src="assets/icons/profile.svg" alt="" class="flagInline"/><span id="name3">P3</span></h3><div class="miniStat" id="s3">0</div><canvas id="opp3" class="mini"></canvas></div>
  </div>

  <div class="stage">
    <h3>Slingshot â€” drag the pouch (bottom center) and release to shoot</h3>
    <div class="userHeader"><img id="avatarUser" src="assets/icons/profile.svg" alt="" class="avatar"/><h3 id="playerName">Player</h3></div>
    <canvas id="userCanvas"></canvas>
    <div class="hint">Only **your** hits play sound. AI plays silently. Smaller targets award more points.</div>
  </div>
</div>

<!-- Results overlay -->
<div id="overlay" class="overlay">
  <div class="modal">
    <h2>Round results</h2>
    <div class="grid two">
      <div class="kpi"><div class="v" id="winner">-</div><div>Winner</div></div>
      <div class="kpi"><div class="v" id="payout">0</div><div>Payout (TPC)</div></div>
    </div>
    <div class="grid two" style="margin-top:10px">
      <div class="kpi"><div class="v" id="fee">0</div><div>Fee 10%</div></div>
      <div class="kpi"><div class="v" id="potFinal">0</div><div>Final Pot</div></div>
    </div>
    <div class="grid" id="scoreList" style="margin-top:10px"></div>
    <div class="row-actions">
      <button id="rematch" class="btn">Rematch</button>
      <button id="close" class="ghost">Close</button>
    </div>
  </div>
</div>

<script src="/falling-ball-api.js"></script>
<script>
/* Max build â€” single init guard */
if(!window.__SLINGSHOT_ROYALE_MAX__){
window.__SLINGSHOT_ROYALE_MAX__ = true;

(function(){
  const params = new URLSearchParams(location.search);
  const avatarParam = params.get('avatar') || '';

  const $ = s => document.querySelector(s);
  const minis = [ $('#opp1'), $('#opp2'), $('#opp3') ];
  const miniScores = [ $('#s1'), $('#s2'), $('#s3') ];
  const userCanvas = $('#userCanvas');
  const nameEls = [$('#name1'), $('#name2'), $('#name3')];
  const avatarEls = [$('#avatar1'), $('#avatar2'), $('#avatar3'), $('#avatarUser')];
  const playerNameEl = $('#playerName');
  const $time = $('#time'), $status = $('#status'), $pot = $('#pot');
  const $overlay = $('#overlay'), $winner = $('#winner'), $payout = $('#payout'), $fee = $('#fee'), $potFinal = $('#potFinal'), $scoreList = $('#scoreList');

  function fit(c){ const r=c.getBoundingClientRect(); c.width=Math.max(10,r.width); c.height=Math.max(10,r.height); }
  function fitAll(){ minis.forEach(fit); fit(userCanvas); }

  const FLAG_EMOJIS = ["ðŸ‡¦ðŸ‡«","ðŸ‡¦ðŸ‡±","ðŸ‡©ðŸ‡¿","ðŸ‡¦ðŸ‡¸","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡´","ðŸ‡¦ðŸ‡®","ðŸ‡¦ðŸ‡¬","ðŸ‡¦ðŸ‡·","ðŸ‡¦ðŸ‡²","ðŸ‡¦ðŸ‡¼","ðŸ‡¦ðŸ‡º","ðŸ‡¦ðŸ‡¹","ðŸ‡¦ðŸ‡¿","ðŸ‡§ðŸ‡¸","ðŸ‡§ðŸ‡­","ðŸ‡§ðŸ‡©","ðŸ‡§ðŸ‡§","ðŸ‡§ðŸ‡¾","ðŸ‡§ðŸ‡ª","ðŸ‡§ðŸ‡¿","ðŸ‡§ðŸ‡¯","ðŸ‡§ðŸ‡²","ðŸ‡§ðŸ‡¹","ðŸ‡§ðŸ‡´","ðŸ‡§ðŸ‡¦","ðŸ‡§ðŸ‡¼","ðŸ‡§ðŸ‡·","ðŸ‡§ðŸ‡¬","ðŸ‡§ðŸ‡«","ðŸ‡§ðŸ‡®","ðŸ‡°ðŸ‡­","ðŸ‡¨ðŸ‡²","ðŸ‡¨ðŸ‡¦","ðŸ‡¨ðŸ‡»","ðŸ‡°ðŸ‡¾","ðŸ‡¨ðŸ‡«","ðŸ‡¹ðŸ‡©","ðŸ‡¨ðŸ‡±","ðŸ‡¨ðŸ‡³","ðŸ‡¨ðŸ‡´","ðŸ‡°ðŸ‡²","ðŸ‡¨ðŸ‡¬","ðŸ‡¨ðŸ‡©","ðŸ‡¨ðŸ‡·","ðŸ‡¨ðŸ‡®","ðŸ‡­ðŸ‡·","ðŸ‡¨ðŸ‡º","ðŸ‡¨ðŸ‡¾","ðŸ‡¨ðŸ‡¿","ðŸ‡©ðŸ‡°","ðŸ‡©ðŸ‡¯","ðŸ‡©ðŸ‡´","ðŸ‡ªðŸ‡¨","ðŸ‡ªðŸ‡¬","ðŸ‡¸ðŸ‡»","ðŸ‡¬ðŸ‡¶","ðŸ‡ªðŸ‡·","ðŸ‡ªðŸ‡ª","ðŸ‡ªðŸ‡¹","ðŸ‡«ðŸ‡¯","ðŸ‡«ðŸ‡®","ðŸ‡«ðŸ‡·","ðŸ‡¬ðŸ‡¦","ðŸ‡¬ðŸ‡²","ðŸ‡¬ðŸ‡ª","ðŸ‡©ðŸ‡ª","ðŸ‡¬ðŸ‡­","ðŸ‡¬ðŸ‡·","ðŸ‡¬ðŸ‡±","ðŸ‡¬ðŸ‡©","ðŸ‡¬ðŸ‡¹","ðŸ‡¬ðŸ‡¬","ðŸ‡¬ðŸ‡³","ðŸ‡¬ðŸ‡¾","ðŸ‡­ðŸ‡¹","ðŸ‡­ðŸ‡³","ðŸ‡­ðŸ‡º","ðŸ‡®ðŸ‡¸","ðŸ‡®ðŸ‡³","ðŸ‡®ðŸ‡©","ðŸ‡®ðŸ‡·","ðŸ‡®ðŸ‡¶","ðŸ‡®ðŸ‡ª","ðŸ‡®ðŸ‡±","ðŸ‡®ðŸ‡¹","ðŸ‡¯ðŸ‡²","ðŸ‡¯ðŸ‡µ","ðŸ‡¯ðŸ‡´","ðŸ‡°ðŸ‡¿","ðŸ‡°ðŸ‡ª","ðŸ‡°ðŸ‡®","ðŸ‡°ðŸ‡¼","ðŸ‡°ðŸ‡¬","ðŸ‡±ðŸ‡¦","ðŸ‡±ðŸ‡»","ðŸ‡±ðŸ‡§","ðŸ‡±ðŸ‡¸","ðŸ‡±ðŸ‡·","ðŸ‡±ðŸ‡¾","ðŸ‡±ðŸ‡®","ðŸ‡±ðŸ‡¹","ðŸ‡±ðŸ‡º","ðŸ‡²ðŸ‡¬","ðŸ‡²ðŸ‡¼","ðŸ‡²ðŸ‡¾","ðŸ‡²ðŸ‡»","ðŸ‡²ðŸ‡±","ðŸ‡²ðŸ‡¹","ðŸ‡²ðŸ‡­","ðŸ‡²ðŸ‡¶","ðŸ‡²ðŸ‡·","ðŸ‡²ðŸ‡º","ðŸ‡²ðŸ‡½","ðŸ‡«ðŸ‡²","ðŸ‡²ðŸ‡©","ðŸ‡²ðŸ‡¨","ðŸ‡²ðŸ‡³","ðŸ‡²ðŸ‡ª","ðŸ‡²ðŸ‡¦","ðŸ‡²ðŸ‡¿","ðŸ‡²ðŸ‡²","ðŸ‡³ðŸ‡¦","ðŸ‡³ðŸ‡·","ðŸ‡³ðŸ‡µ","ðŸ‡³ðŸ‡±","ðŸ‡³ðŸ‡¿","ðŸ‡³ðŸ‡®","ðŸ‡³ðŸ‡ª","ðŸ‡³ðŸ‡¬","ðŸ‡³ðŸ‡´","ðŸ‡´ðŸ‡²","ðŸ‡µðŸ‡°","ðŸ‡µðŸ‡¼","ðŸ‡µðŸ‡¦","ðŸ‡µðŸ‡¬","ðŸ‡µðŸ‡¾","ðŸ‡µðŸ‡ª","ðŸ‡µðŸ‡­","ðŸ‡µðŸ‡±","ðŸ‡µðŸ‡¹","ðŸ‡µðŸ‡·","ðŸ‡¶ðŸ‡¦","ðŸ‡·ðŸ‡´","ðŸ‡·ðŸ‡º","ðŸ‡·ðŸ‡¼","ðŸ‡¸ðŸ‡²","ðŸ‡¸ðŸ‡¦","ðŸ‡¸ðŸ‡³","ðŸ‡·ðŸ‡¸","ðŸ‡¸ðŸ‡¨","ðŸ‡¸ðŸ‡±","ðŸ‡¸ðŸ‡¬","ðŸ‡¸ðŸ‡°","ðŸ‡¸ðŸ‡®","ðŸ‡¸ðŸ‡§","ðŸ‡¸ðŸ‡´","ðŸ‡¿ðŸ‡¦","ðŸ‡ªðŸ‡¸","ðŸ‡±ðŸ‡°","ðŸ‡¸ðŸ‡ª","ðŸ‡¨ðŸ‡­","ðŸ‡¸ðŸ‡¾","ðŸ‡¹ðŸ‡¼","ðŸ‡¹ðŸ‡¯","ðŸ‡¹ðŸ‡¿","ðŸ‡¹ðŸ‡­","ðŸ‡¹ðŸ‡±","ðŸ‡¹ðŸ‡´","ðŸ‡¹ðŸ‡¹","ðŸ‡¹ðŸ‡³","ðŸ‡¹ðŸ‡·","ðŸ‡¹ðŸ‡²","ðŸ‡ºðŸ‡¬","ðŸ‡ºðŸ‡¦","ðŸ‡¦ðŸ‡ª","ðŸ‡¬ðŸ‡§","ðŸ‡ºðŸ‡¸","ðŸ‡ºðŸ‡¾","ðŸ‡ºðŸ‡¿","ðŸ‡»ðŸ‡ª","ðŸ‡»ðŸ‡³","ðŸ‡¾ðŸ‡ª","ðŸ‡¿ðŸ‡²","ðŸ‡¿ðŸ‡¼"];
  const emojiToDataUrl = (e)=>`data:image/svg+xml,${encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><text y='96' font-size='96'>"+e+"</text></svg>")}`;
  const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
  const flagToName = (flag)=>{
    const codePoints = Array.from(flag, c => c.codePointAt(0) - 0x1f1e6 + 0x41);
    const countryCode = String.fromCharCode(...codePoints);
    return regionNames.of(countryCode) || flag;
  };
  function adjustNameSize(el){
    if(!el) return; const len=el.textContent.length; el.style.fontSize = len>12?'10px':(len>8?'12px':'14px');
  }

  const userData = window?.Telegram?.WebApp?.initDataUnsafe?.user;

  function setupPlayers(n){
    for(let i=0;i<minis.length;i++){
      const card = minis[i].parentElement;
      if(i < n-1){
        card.style.display='';
        const flag = FLAG_EMOJIS[(Math.random()*FLAG_EMOJIS.length)|0];
        const url = emojiToDataUrl(flag);
        avatarEls[i].src = url;
        nameEls[i].textContent = flagToName(flag);
        adjustNameSize(nameEls[i]);
        miniScores[i].textContent='0';
      } else {
        card.style.display='none';
      }
    }
    if(playerNameEl){
      const playerName = userData?.username || [userData?.first_name, userData?.last_name].filter(Boolean).join(' ') || 'Player';
      playerNameEl.textContent = playerName; adjustNameSize(playerNameEl);
    }
    if(avatarParam) avatarEls[3].src = avatarParam; else if(userData?.photo_url) avatarEls[3].src = userData.photo_url;
  }

  /* ====== Audio (user only) ====== */
  let audio=null, muted=true;
  function ensureAudio(){ if(!audio){ const AC=window.AudioContext||window.webkitAudioContext; if(AC) audio = new AC(); } }
  function playTwang(){
    if(!audio || muted) return;
    const t=audio.currentTime, o=audio.createOscillator(), g=audio.createGain();
    o.type='triangle'; o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(110,t+0.25);
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.45,t+0.03); g.gain.exponentialRampToValueAtTime(0.0001,t+0.32);
    o.connect(g).connect(audio.destination); o.start(t); o.stop(t+0.34);
  }
  function playGlass(){
    if(!audio || muted) return;
    const t=audio.currentTime, d=0.5;
    const buf=audio.createBuffer(1, audio.sampleRate*d, audio.sampleRate);
    const ch=buf.getChannelData(0);
    for(let i=0;i<ch.length;i++){ const dec=Math.exp(-i/(audio.sampleRate*0.18)); ch[i]=(Math.random()*2-1)*dec; }
    const src=audio.createBufferSource(); src.buffer=buf;
    const hp=audio.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1800;
    const g=audio.createGain(); g.gain.value=0.6; src.connect(hp).connect(g).connect(audio.destination); src.start(t);
  }

  /* ====== Layout / shelves ====== */
  const DEPTHS = [
    { z:0.55, y:0.14, base:10 },
    { z:0.75, y:0.28, base:14 },
    { z:0.90, y:0.43, base:18 },
    { z:1.05, y:0.58, base:22 }
  ];
  const MARGIN_X = W => W*0.08;   // 8% left/right
  const INNER_W  = W => W*0.84;

  /* ====== Draw utils ====== */
  function rrect(ctx,x,y,w,h,r){
    r=Math.min(r,Math.abs(w)/2,Math.abs(h)/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
    ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
    ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath();
  }
  function drawShelf(ctx, W, y){
    const left=MARGIN_X(W), width=INNER_W(W), h=12;
    const g=ctx.createLinearGradient(0,y-h,0,y); g.addColorStop(0,'#7a542f'); g.addColorStop(1,'#5f3f22');
    ctx.fillStyle=g; ctx.fillRect(left,y-h,width,h);
    ctx.strokeStyle='#3e2816'; ctx.lineWidth=2; ctx.strokeRect(left,y-h,width,h);
  }

  // Glass palettes
  const glassPal = [
    { light:'rgba(160,255,200,0.35)', mid:'rgba(90,200,140,0.28)', dark:'rgba(40,120,80,0.25)' },
    { light:'rgba(160,220,255,0.35)', mid:'rgba(100,160,210,0.28)', dark:'rgba(40,80,120,0.25)' }
  ];
  function bottleOutline(ctx, kind, r){
    ctx.beginPath();
    if(kind==='long'){
      const w=r*0.9, h=r*2.1;
      ctx.moveTo(-w*0.5,0); ctx.quadraticCurveTo(-w*0.55,-h*0.2,-w*0.25,-h*0.45);
      ctx.lineTo(-w*0.18,-h*0.9); ctx.quadraticCurveTo(0,-h,w*0.18,-h*0.9); ctx.lineTo(w*0.25,-h*0.45);
      ctx.quadraticCurveTo(w*0.55,-h*0.2,w*0.5,0); ctx.closePath();
    } else if(kind==='short'){
      const w2=r*1.2, h2=r*1.6;
      ctx.moveTo(-w2*0.6,0); ctx.quadraticCurveTo(-w2*0.62,-h2*0.2,-w2*0.3,-h2*0.45);
      ctx.lineTo(-w2*0.2,-h2*0.7); ctx.quadraticCurveTo(0,-h2,w2*0.2,-h2*0.7);
      ctx.lineTo(w2*0.3,-h2*0.45); ctx.quadraticCurveTo(w2*0.62,-h2*0.2,w2*0.6,0); ctx.closePath();
    } else {
      const w3=r*1.1, h3=r*1.9;
      ctx.moveTo(-w3*0.55,0); ctx.quadraticCurveTo(-w3*0.55,-h3*0.2,-w3*0.25,-h3*0.45);
      ctx.quadraticCurveTo(0,-h3,w3*0.25,-h3*0.45);
      ctx.quadraticCurveTo(w3*0.55,-h3*0.2,w3*0.55,0); ctx.closePath();
    }
  }
  function drawBottle(ctx,b){
    ctx.save(); ctx.translate(b.x,b.y);
    const g=ctx.createLinearGradient(0,-b.r*2.2,0,b.r*0.2);
    g.addColorStop(0,b.pal.light); g.addColorStop(0.5,b.pal.mid); g.addColorStop(1,b.pal.dark);
    ctx.fillStyle=g; ctx.strokeStyle='rgba(230,245,255,0.6)'; ctx.lineWidth=2;
    bottleOutline(ctx,b.kind,b.r); ctx.fill(); ctx.stroke();
    ctx.globalAlpha=0.45; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.ellipse(-b.r*0.35,-b.r*0.8, b.r*0.12, b.r*0.5, -0.2, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
    ctx.restore();
  }
  function drawCup(ctx,x,y,s){
    ctx.save(); ctx.translate(x,y);
    ctx.fillStyle='#fff'; ctx.strokeStyle='#d6dbe6'; ctx.lineWidth=2;
    rrect(ctx,-12*s,-14*s,24*s,16*s,6*s); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(14*s,-8*s,6*s,-Math.PI/2,Math.PI/2); ctx.stroke(); // handle
    ctx.restore();
  }
  function drawBeer(ctx,x,y,s){
    ctx.save(); ctx.translate(x,y);
    const g=ctx.createLinearGradient(0,-24*s,0,0); g.addColorStop(0,'#ffd26e'); g.addColorStop(1,'#d9992a');
    ctx.fillStyle=g; ctx.strokeStyle='#e7c27a'; ctx.lineWidth=2;
    rrect(ctx,-14*s,-24*s,28*s,24*s,6*s); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.ellipse(-6*s,-24*s,8*s,5*s,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(6*s,-24*s,9*s,5*s,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#d6dbe6'; ctx.lineWidth=4; rrect(ctx,14*s,-16*s,10*s,14*s,6*s); ctx.stroke();
    ctx.restore();
  }
  function drawFlute(ctx,x,y,s){
    ctx.save(); ctx.translate(x,y);
    ctx.strokeStyle='rgba(220,240,255,0.9)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(-6*s,-28*s); ctx.quadraticCurveTo(-4*s,-32*s,0,-32*s); ctx.quadraticCurveTo(4*s,-32*s,6*s,-28*s); ctx.lineTo(3*s,-8*s); ctx.lineTo(-3*s,-8*s); ctx.closePath(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0,-8*s); ctx.lineTo(0,0); ctx.stroke();
    ctx.beginPath(); ctx.ellipse(0,2*s,10*s,3*s,0,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  }
  function drawChampBottle(ctx,x,y,s){
    ctx.save(); ctx.translate(x,y);
    const g=ctx.createLinearGradient(0,-36*s,0,0); g.addColorStop(0,'#4d7f4d'); g.addColorStop(1,'#2d4f2d');
    ctx.fillStyle=g; ctx.strokeStyle='#c7d6c7'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(-10*s,0); ctx.quadraticCurveTo(-12*s,-12*s,-6*s,-26*s); ctx.lineTo(-4*s,-34*s);
    ctx.quadraticCurveTo(0,-36*s,4*s,-34*s); ctx.lineTo(6*s,-26*s);
    ctx.quadraticCurveTo(12*s,-12*s,10*s,0); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#d4af37'; ctx.fillRect(-6*s,-26*s,12*s,8*s);
    ctx.restore();
  }

  function sizeScore(base, radius){
    const REF=26;
    const factor = Math.max(0.6, Math.min(1.9, REF / Math.max(8, radius)));
    return Math.round(base * factor);
  }

  /* ====== Game board ====== */
  function makeBoard(canvas, isUser){
    fit(canvas);
    const ctx = canvas.getContext('2d');
    const W = ()=>canvas.width, H = ()=>canvas.height;

    let shelves=[], items=[], shards=[], shots=[], floaters=[];
    let sling={ xRel:0.5, yRel:0.935, dragging:false, pull:{x:0,y:0}, r:14, cd:0 };
    let score=0, nextAi=performance.now()+1500+Math.random()*900;

    function spawn(slot){
      const z=slot.shelf.z, base=slot.shelf.base;
      if(Math.random()<0.6){
        const r=(18 + Math.random()*14)*z;
        const obj={type:'bottle',x:slot.x,y:slot.shelf.y-8,z, r, pal:glassPal[(Math.random()<0.5)?0:1], kind:['long','short','round'][(Math.random()*3)|0], score:sizeScore(base,r), slot};
        items.push(obj);
      }else{
        const kinds=['cup','beer','flute','champ']; const kind=kinds[(Math.random()*4)|0];
        const approxR = (kind==='flute')? 14*z : (kind==='cup'? 18*z : 22*z);
        items.push({type:kind,x:slot.x,y:slot.shelf.y-8,z, score:sizeScore(base+2,approxR), slot});
      }
      slot.occupied=true;
    }
    function respawn(slot){ slot.occupied=false; slot.item=null; setTimeout(()=>spawn(slot), 420+Math.random()*480); }

    function build(){
      shelves.length=items.length=shards.length=shots.length=floaters.length=0;
      for(let d=0; d<DEPTHS.length; d++){
        const layer=DEPTHS[d]; const y=H()*layer.y, z=layer.z, base=layer.base;
        const cols = Math.max(8, Math.min(14, Math.floor(INNER_W(W())/78)));
        const left=MARGIN_X(W()), cell=INNER_W(W())/cols;
        const shelf={y,z,base,slots:[]};
        for(let i=0;i<cols;i++){ shelf.slots.push({x:left+(i+0.5)*cell, shelf, occupied:false, item:null}); }
        shelves.push(shelf);
      }
      for(const s of shelves) for(const sl of s.slots) spawn(sl);
    }

    function addShards(x,y){
      for(let i=0;i<26;i++){ const a=Math.random()*Math.PI*2, sp=Math.random()*3+1.5;
        shards.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-1,life:600,r:Math.random()*2+0.8}); }
      if(isUser) playGlass();
    }
    function addText(x,y,t){ floaters.push({x,y,t:800,txt:'+'+t}); }

    function update(dt){
      sling.cd=Math.max(0,sling.cd-dt);
      for(let i=shots.length-1;i>=0;i--){
        const p=shots[i];
        p.vy+=0.12*(dt*0.06);
        p.x+=p.vx*(dt*0.06); p.y+=p.vy*(dt*0.06); p.life-=dt;
        let hit=-1;
        for(let j=0;j<items.length;j++){
          const it=items[j];
          let R=(it.type==='bottle')? it.r*0.9 : 16*it.z; if(it.type==='champ') R=18*it.z; if(it.type==='flute') R=10*it.z;
          const cx=it.x, cy=it.y-18*it.z; const dx=p.x-cx, dy=p.y-cy;
          if(dx*dx+dy*dy <= (p.r+R)*(p.r+R)){ hit=j; break; }
        }
        if(hit>=0){
          const obj=items[hit];
          addText(obj.x, obj.y-24*obj.z, obj.score);
          addShards(obj.x, obj.y-24*obj.z);
          score += obj.score;
          const sl = obj.slot; items.splice(hit,1); if(sl) respawn(sl);
          p.vx *= 0.6; p.vy *= 0.6;
        }
        if(p.life<=0 || p.x<-60 || p.x>W()+60 || p.y>H()+60) shots.splice(i,1);
      }
      for(let k=shards.length-1;k>=0;k--){ const s=shards[k]; s.life-=dt; if(s.life<=0){ shards.splice(k,1); continue; } s.x+=s.vx*(dt*0.06); s.y+=s.vy*(dt*0.06); s.vy+=0.02; }
      for(let f=floaters.length-1; f>=0; f--){ const F=floaters[f]; F.t-=dt; if(F.t<=0) floaters.splice(f,1); }

      const now=performance.now();
      if(!isUser && now>=nextAi){
        if(Math.random()<0.18){ nextAi = now + 650 + Math.random()*600; return; }
        const list=items.slice();
        if(list.length){
          const freestyle = Math.random()<0.25;
          const sx=W()*sling.xRel, sy=H()*sling.yRel;
          let vx, vy;
          if(!freestyle){
            const t=list[(Math.random()*list.length)|0];
            const tx=t.x + (Math.random()*24-12), ty=(t.y-22*t.z)+(Math.random()*14-7);
            const speed=13+Math.random()*4, base=-1.2+(Math.random()*0.5-0.25);
            let best=null;
            for(let da=-0.30; da<=0.30; da+=0.06){
              const ang=base+da, vx0=Math.cos(ang)*speed, vy0=Math.sin(ang)*speed;
              let ok=false;
              for(let step=0; step<46; step++){
                const g=0.12, tstep=step*2*0.06;
                const x=sx+vx0*tstep, y=sy+(vy0+g*(step*2))*tstep;
                if((x-tx)*(x-tx)+(y-ty)*(y-ty) < (18*t.z)*(18*t.z)){ ok=true; break; }
              }
              if(ok){ best={vx:vx0,vy:vy0}; break; }
            }
            const jit=(Math.random()*0.18-0.09);
            vx=(best?best.vx:11.5)+jit; vy=(best?best.vy:-9.5)+jit;
          } else {
            const a2=-0.9-Math.random()*0.65, sp=12.5+Math.random()*4.5; vx=Math.cos(a2)*sp; vy=Math.sin(a2)*sp;
          }
          shots.push({x:sx,y:sy,vx,vy,r:sling.r,life:5000});
        }
        nextAi = now + (1400 + Math.random()*900);
      }
    }

    function draw(){
      ctx.clearRect(0,0,W(),H());
      ctx.strokeStyle='#162047'; ctx.globalAlpha=0.25;
      for(let x=0;x<W();x+=24){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H()); ctx.stroke(); }
      for(let y=0;y<H();y+=24){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W(),y); ctx.stroke(); }
      ctx.globalAlpha=1;
      for(const d of DEPTHS) drawShelf(ctx, W(), H()*d.y);
      for(const it of items){
        if(it.type==='bottle') drawBottle(ctx,it);
        else if(it.type==='cup')  drawCup(ctx,it.x,it.y-2*it.z,1.0*it.z);
        else if(it.type==='beer') drawBeer(ctx,it.x,it.y-2*it.z,1.0*it.z);
        else if(it.type==='flute') drawFlute(ctx,it.x,it.y,1.0*it.z);
        else if(it.type==='champ') drawChampBottle(ctx,it.x,it.y,1.0*it.z);
      }
      if(isUser){
        const x=W()*sling.xRel, y=H()*sling.yRel;
        ctx.strokeStyle='#6b4b2a'; ctx.lineWidth=12; ctx.lineCap='round';
        ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x,y-100); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x,y-100); ctx.lineTo(x-34,y-132); ctx.moveTo(x,y-100); ctx.lineTo(x+34,y-132); ctx.stroke();
        ctx.strokeStyle='#caa15f'; ctx.lineWidth=5;
        const ox=sling.dragging?sling.pull.x:0, oy=sling.dragging?sling.pull.y:0;
        ctx.beginPath(); ctx.moveTo(x-34,y-132); ctx.lineTo(x+ox,y+oy); ctx.moveTo(x+34,y-132); ctx.lineTo(x+ox,y+oy); ctx.stroke();
        ctx.fillStyle='#a37b45'; ctx.beginPath(); ctx.ellipse(x+ox,y+oy,22,13,0,0,Math.PI*2); ctx.fill();
        const g=ctx.createRadialGradient(x+ox-7,y+oy-7,4, x+ox,y+oy, sling.r+2);
        g.addColorStop(0,'#ffffff88'); g.addColorStop(0.2,'#ff6b7a'); g.addColorStop(1,'#a11422');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x+ox,y+oy,sling.r,0,Math.PI*2); ctx.fill();
      }
      for(const p of shots){
        const g2=ctx.createRadialGradient(p.x-6,p.y-6,4, p.x,p.y, p.r+1);
        g2.addColorStop(0,'#ffffff88'); g2.addColorStop(0.2,'#ff6b7a'); g2.addColorStop(1,'#a11422');
        ctx.fillStyle=g2; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      }
      for(const sh of shards){
        const a=Math.max(0, sh.life/600);
        ctx.fillStyle='rgba(200,230,255,'+a+')';
        ctx.beginPath(); ctx.moveTo(sh.x, sh.y); ctx.lineTo(sh.x+sh.r, sh.y+sh.r*0.3); ctx.lineTo(sh.x-sh.r*0.2, sh.y+sh.r*0.8); ctx.closePath(); ctx.fill();
      }
      for(const fl of floaters){
        const k=1-fl.t/800;
        ctx.fillStyle='rgba(212,175,55,'+(1-k)+')'; ctx.font='bold 16px system-ui'; ctx.textAlign='center';
        ctx.fillText(fl.txt, fl.x, fl.y - k*24);
      }
    }

    if(isUser){
      ['pointerdown','touchstart','mousedown'].forEach(ev=>{
        canvas.addEventListener(ev, ()=>{ ensureAudio(); }, {once:true});
      });
      canvas.addEventListener('pointerdown', e=>{
        const r=canvas.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
        const sx=W()*sling.xRel, sy=H()*sling.yRel;
        if(Math.hypot(x-sx,y-sy) < 140 && sling.cd<=0){ sling.dragging=true; sling.pull.x=0; sling.pull.y=0; }
      });
      canvas.addEventListener('pointermove', e=>{
        if(!sling.dragging) return;
        const r=canvas.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
        const sx=W()*sling.xRel, sy=H()*sling.yRel;
        const mx=x-sx, my=y-sy, max=Math.min(W(),H())*0.30;
        const mag=Math.hypot(mx,my)||1, k=Math.min(1,mag/max);
        sling.pull.x=(mx/mag)*k*max; sling.pull.y=(my/mag)*k*max;
      });
      function release(){
        if(!sling.dragging) return;
        const sx=W()*sling.xRel, sy=H()*sling.yRel;
        const power=0.24, vx=-sling.pull.x*power, vy=-sling.pull.y*power;
        shots.push({x:sx,y:sy,vx,vy,r:sling.r,life:5000});
        playTwang();
        sling.dragging=false; sling.pull.x=0; sling.pull.y=0; sling.cd=420;
      }
      canvas.addEventListener('pointerup', release);
      canvas.addEventListener('pointercancel', ()=>{ sling.dragging=false; sling.pull.x=0; sling.pull.y=0; });
    }

    build();
    return {
      update:(dt)=>update(dt),
      draw:()=>draw(),
      get score(){ return score; }
    };
  }

  let running=false, endAt=0, last=performance.now(), games=[];
  function fmt(secs){ secs=Math.max(0,secs|0); const m=('0'+((secs/60)|0)).slice(-2), s=('0'+(secs%60)).slice(-2); return m+':'+s; }

  function start(){
    fitAll();
    $status.textContent='Playing';
    const n=Math.max(2,Math.min(4,parseInt($('#players').value,10)||4));
    const dur=parseInt($('#duration').value,10)||180;
    const stake=Math.max(0, parseInt($('#stake').value||'0',10));
    $time.textContent=fmt(dur);
    $pot.textContent=String(n*stake);

    setupPlayers(n);
    games.length=0;
    for(let i=0;i<n-1;i++) games.push(makeBoard(minis[i], false));
    games.push(makeBoard(userCanvas, true));

    endAt = performance.now() + dur*1000;
    running=true; last=performance.now();
    loop();
  }

  function loop(){
    if(!running) return;
    const now=performance.now(), dt=now-last; last=now;
    for(let i=0;i<games.length;i++){
      games[i].update(dt); games[i].draw();
      if(i<3 && miniScores[i]) miniScores[i].textContent = String(games[i].score||0);
    }
    const secs=Math.max(0, Math.ceil((endAt-now)/1000));
    $time.textContent=fmt(secs);
    if(secs<=0){ finish(); return; }
    requestAnimationFrame(loop);
  }

  function finish(){
    running=false;
    $status.textContent='Finished';
    const stake=Math.max(0, parseInt($('#stake').value||'0',10));
    const gross = stake * games.length;
    const feeAmt = Math.round(gross * 0.10);
    const net = gross - feeAmt;

    const scores = games.map((g,i)=>({i,score:g.score||0}));
    const max = Math.max(...scores.map(s=>s.score));
    const winners = scores.filter(s=>s.score===max);
    const payout = winners.length ? Math.floor(net / winners.length) : 0;

    $winner.textContent = winners.length>1 ? ('Tie ('+winners.map(w=>'P'+(w.i+1)).join(', ')+')') : ('P'+(winners[0].i+1));
    $payout.textContent = String(payout);
    $fee.textContent = String(feeAmt);
    $potFinal.textContent = String(net);
    scores.sort((a,b)=>b.score-a.score);
    $scoreList.innerHTML = scores.map(s=>(
      "<div class='kpi'><div class='v'>P"+(s.i+1)+": "+s.score+"</div><div>â€”</div></div>"
    )).join('');

    $overlay.style.display='flex';
  }

  $('#start').addEventListener('click', ()=>{ ensureAudio(); start(); });
  $('#rematch').addEventListener('click', ()=>{ $overlay.style.display='none'; start(); });
  $('#close').addEventListener('click', ()=>{ $overlay.style.display='none'; });

  $('#mute').addEventListener('click', function(){
    muted = !muted;
    this.textContent = muted ? 'ðŸ”‡' : 'ðŸ”Š';
    if(!muted) ensureAudio();
  });

  window.addEventListener('resize', fitAll);
  fitAll();
})();
}
</script>
</body>
</html>
