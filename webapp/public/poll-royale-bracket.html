<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pool Royale Tournament</title>
  <style>
    body{margin:0;background:#0b1020;color:#dbe7ff;font-family:system-ui;padding:16px;}
    h2{text-align:center;margin-top:0;}
    #bracket{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;}
    .round{display:flex;flex-direction:column;gap:8px;}
    .match{background:#11172a;border:1px solid #233155;padding:4px 8px;border-radius:4px;min-width:140px;text-align:center;}
    .winner{font-weight:bold;color:#f97316;}
    #continueBtn{margin-top:20px;padding:8px 16px;background:#2563eb;border:none;color:#fff;border-radius:4px;}
  </style>
</head>
<body>
  <h2>Tournament Bracket</h2>
  <div id="bracket"></div>
  <div style="text-align:center"><button id="continueBtn">Continue</button></div>
  <script src="/tournament.js"></script>
  <script>
  (function(){
    const params = new URLSearchParams(location.search);
    const totalPlayers = parseInt(params.get('players') || '8', 10);
    const playerName = params.get('name') || 'Player';
    let state = Tournament.load();
    if(!state){
      const aiPool = [
        { name: 'USA', flag: '🇺🇸' },
        { name: 'UK', flag: '🇬🇧' },
        { name: 'Germany', flag: '🇩🇪' },
        { name: 'Brazil', flag: '🇧🇷' },
        { name: 'Japan', flag: '🇯🇵' },
        { name: 'France', flag: '🇫🇷' },
        { name: 'Spain', flag: '🇪🇸' },
        { name: 'Italy', flag: '🇮🇹' },
        { name: 'Canada', flag: '🇨🇦' },
        { name: 'India', flag: '🇮🇳' },
        { name: 'China', flag: '🇨🇳' },
        { name: 'Mexico', flag: '🇲🇽' },
        { name: 'Australia', flag: '🇦🇺' },
        { name: 'Russia', flag: '🇷🇺' },
        { name: 'Netherlands', flag: '🇳🇱' },
        { name: 'Sweden', flag: '🇸🇪' },
        { name: 'Norway', flag: '🇳🇴' },
        { name: 'Denmark', flag: '🇩🇰' },
        { name: 'Poland', flag: '🇵🇱' },
        { name: 'Switzerland', flag: '🇨🇭' },
        { name: 'Greece', flag: '🇬🇷' },
        { name: 'Turkey', flag: '🇹🇷' },
        { name: 'Portugal', flag: '🇵🇹' },
        { name: 'Belgium', flag: '🇧🇪' }
      ];
      const players = [{ name: playerName, flag: '🏳️' }];
      for(let i=0;i<totalPlayers-1;i++) players.push(aiPool[i]);
      state = Tournament.createTournament(players);
      Tournament.save(state);
    }
    draw();

    document.getElementById('continueBtn').addEventListener('click', () => {
      state = Tournament.load();
      if(state.finished){
        sessionStorage.removeItem('pollroyaleTournament');
        const win = state.champion === state.userIndex ? 1 : 2;
        location.href = `/games/pollroyale/lobby?winner=${win}`;
        return;
      }
      const nm = Tournament.getNextUserMatch(state);
      Tournament.save(state);
      if(!nm){
        // user eliminated and tournament still running? simulate to end
        Tournament.simulateRemaining(state, 0);
        state.finished = true;
        Tournament.save(state);
        draw();
      }else{
        location.href = `/poll-royale.html?${params.toString()}`;
      }
    });

    function draw(){
      state = Tournament.load();
      const bracketEl = document.getElementById('bracket');
      bracketEl.innerHTML = '';
      state.rounds.forEach((round) => {
        const col = document.createElement('div');
        col.className = 'round';
        round.forEach((match) => {
          const p1 = state.players[match.p1];
          const p2 = state.players[match.p2];
          const div = document.createElement('div');
          div.className = 'match';
          let html = `${p1.flag} ${p1.name}<br/>${p2.flag} ${p2.name}`;
          if(match.winner === match.p1) html = `<span class="winner">${p1.flag} ${p1.name}</span><br/>${p2.flag} ${p2.name}`;
          else if(match.winner === match.p2) html = `${p1.flag} ${p1.name}<br/><span class="winner">${p2.flag} ${p2.name}</span>`;
          div.innerHTML = html;
          col.appendChild(div);
        });
        bracketEl.appendChild(col);
      });
      if(state.finished){
        const champ = state.players[state.champion];
        const title = document.querySelector('h2');
        title.textContent = `Winner: ${champ.flag} ${champ.name}`;
        document.getElementById('continueBtn').textContent = 'Close';
      }
    }
  })();
  </script>
</body>
</html>
