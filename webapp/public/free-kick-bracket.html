<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Free Kick Bracket</title>
<style>
  :root{
    --bg:#0b1020;
    --panel:#11172a;
    --ink:#dbe7ff;
    --accent:#2563eb;
    --accent-2:#f97316;
    --accent-3:#a855f7;
    --muted:#8aa0d1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    background: radial-gradient(80% 60% at 50% 0%, #0f1735 0%, var(--bg) 60%);
    color:var(--ink);
    display:flex; flex-direction:column; gap:10px;
  }
  /* Original demo toolbar and notes are hidden */
  header, .setup, .footer-note{display:none}
  .canvas-wrap{
    position:relative;
    overflow:auto; /* allow horizontal scroll on phones */
    border-top:1px solid rgba(255,255,255,.06);
    border-bottom:1px solid rgba(255,255,255,.06);
    background:
      radial-gradient(1000px 300px at 50% -50px, rgba(37,99,235,.25), transparent 70%),
      radial-gradient(800px 300px at 50% 100%, rgba(249,115,22,.15), transparent 70%);
  }
  canvas{ display:block; margin:0 auto; }
  .footer-note{padding:8px 12px; text-align:center; color:var(--muted); font-size:.85rem}
  details{margin-left:auto}
  summary{cursor:pointer}
  .pill {
    display:inline-flex; align-items:center; gap:8px; padding:4px 8px; border-radius:999px;
    background:rgba(37,99,235,.15); border:1px solid rgba(37,99,235,.35); color:#cfe0ff;
    font-size:.8rem;
  }
  .coin-confetti{position:fixed;top:-40px;width:32px;height:32px;pointer-events:none;animation:coin-fall var(--duration,3s) linear forwards}
  @keyframes coin-fall{from{transform:translateY(-10vh) rotate(0deg);opacity:1}to{transform:translateY(100vh) rotate(360deg);opacity:0}}
</style>
</head>
<body>
<div class="canvas-wrap">
  <canvas id="board" width="1200" height="800" aria-label="Tournament bracket canvas"></canvas>
</div>

<button id="continueBtn" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:8px 16px;border:none;border-radius:6px;background:var(--accent);color:var(--ink);">Continue</button>

<script src="/flag-emojis.js"></script>
<script>
(function(){
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const canvas = document.getElementById('board');
  const ctx = canvas.getContext('2d');
  const params = new URLSearchParams(window.location.search);
  const tgKey = params.get("tgId") || "anon";
  const STATE_KEY = `freeKickTournamentState_${tgKey}`;
  const OPP_KEY = `freeKickTournamentOpponent_${tgKey}`;
  const theme = {
    bg:'#0b1020',
    panel:'#11172a',
    ink:'#dbe7ff',
    muted:'#8aa0d1',
    neonA:'#2563eb',
    neonB:'#f97316',
    neonC:'#a855f7',
    line:'#233155'
  };
  const tpcImg = new Image();
  tpcImg.src = '/assets/icons/ezgif-54c96d8a9b9236.webp';

  let hitRegions = []; // {round, match, slot, x,y,w,h}

  let state = {
    players: [],
    N: 0,
    bracketN: 0,
    rounds: [],
    seedToPlayer: {},
    pot: 0,
    userSeed: 1,
    currentRound: 0,
    championSeed: 0,
    complete: false
  };

  function nextPow2(n){ let p=1; while(p<n) p<<=1; return p; }

  function seedOrder(N){
    if(N===2) return [1,2];
    const prev = seedOrder(N/2);
    const mirror = prev.map(x => N + 1 - x);
    return prev.concat(mirror);
  }

  function round0PairsFromSeeds(N){
    const order = seedOrder(N);
    const pairs = [];
    for(let i=0;i<N;i+=2){
      pairs.push([order[i], order[i+1]]);
    }
    return pairs;
  }

  function createBracket(players){
    const Nrequested = players.length;
    const pow2 = nextPow2(Nrequested);
    state.N = Nrequested;
    state.bracketN = pow2;
    const seedToPlayer = {};
    for(let s=1; s<=pow2; s++){
      if(s<=Nrequested) seedToPlayer[s]=players[s-1];
      else seedToPlayer[s]={name:'BYE'};
    }
    state.seedToPlayer = seedToPlayer;

    const r0 = round0PairsFromSeeds(pow2);
    state.rounds = [r0];
    let matches = r0.length;
    while(matches>1){
      matches = Math.ceil(matches/2);
      state.rounds.push(Array.from({length:matches}, _=>[0,0]));
    }
    layoutAndDraw();
  }

  function layoutAndDraw(){
    const rounds = state.rounds.length;
    const colW = 220;
    const colGap = 64;
    const padX = 24;
    const padY = 24;
    const widthCSS = padX*2 + rounds*colW + (rounds-1)*colGap;

    const matches0 = state.rounds[0].length;

    const boxH = 56;
    const slotH = boxH/2;
    const baseGap = 28;

    const centers = [];
    centers[0] = Array.from({length:matches0}, (_,i)=> padY + (boxH/2) + i*(boxH + baseGap));
    for(let r=1; r<rounds; r++){
      const prev = centers[r-1];
      const arr=[];
      for(let i=0;i<Math.ceil(prev.length/2);i++){
        const c = (prev[2*i] + prev[2*i+1]) / 2;
        arr.push(c);
      }
      centers[r]=arr;
    }

    const lastCenter = centers[rounds-1][0] || padY + boxH/2;
    const heightCSS = Math.max(600, lastCenter + padY + boxH/2);

    canvas.style.width = widthCSS + 'px';
    canvas.style.height = heightCSS + 'px';
    canvas.width = Math.floor(widthCSS * DPR);
    canvas.height = Math.floor(heightCSS * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);

    ctx.clearRect(0,0,widthCSS,heightCSS);
    drawBackground(widthCSS, heightCSS);

    hitRegions = [];
    for(let r=0;r<rounds;r++){
      const x = padX + r*(colW + colGap);
      drawRoundTitle(r, x, 6 + (r==0? 10:0));

      const matchesR = state.rounds[r].length;
      for(let m=0;m<matchesR;m++){
        const yCenter = centers[r][m];
        drawMatchBox(r, m, x, yCenter - boxH/2, colW, boxH, slotH);
      }

      if(r>0){
        const xPrev = padX + (r-1)*(colW + colGap) + colW;
        const xConn = xPrev + 18;
        ctx.lineWidth = 2;
        ctx.strokeStyle = theme.line;
        ctx.beginPath();
        for(let m=0;m<state.rounds[r].length;m++){
          const cy = centers[r][m];
          const top = centers[r-1][2*m];
          const bot = centers[r-1][2*m+1];
          ctx.moveTo(xPrev, top);
          ctx.lineTo(xConn, top);
          ctx.moveTo(xPrev, bot);
          ctx.lineTo(xConn, bot);
          ctx.moveTo(xConn, top);
          ctx.lineTo(xConn, bot);
          ctx.moveTo(xConn, cy);
          ctx.lineTo(x, cy);
        }
        ctx.stroke();
      }
    }

    drawCenterLabels(widthCSS);
  }

  function drawBackground(w,h){
    const g = ctx.createLinearGradient(0,0,w,0);
    g.addColorStop(0,'rgba(168,85,247,.08)');
    g.addColorStop(.5,'rgba(37,99,235,.10)');
    g.addColorStop(1,'rgba(249,115,22,.08)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);
  }

  function drawRoundTitle(r, x, topPad){
    ctx.save();
    ctx.fillStyle = '#bcd0ff';
    ctx.font = '600 12px system-ui,Segoe UI,Roboto,Arial';
    ctx.textAlign = 'left';
    let label = '';
    const rounds = state.rounds.length;
    if(r === 0) label = 'ROUND OF ' + state.N;
    else if(r === rounds-1){
      label = 'FINAL üèÜ ';
      ctx.fillText(label, x, topPad + 10);
      let imgX = x + ctx.measureText(label).width + 2;
      if (tpcImg.complete){
        ctx.drawImage(tpcImg, imgX, topPad, 12, 12);
        imgX += 16;
      }
      ctx.fillText(String(state.pot), imgX, topPad + 10);
      ctx.restore();
      return;
    }
    else if(r === rounds-2) label = 'SEMIFINAL';
    else label = 'QUARTER / R' + (r+1);
    ctx.fillText(label, x, topPad + 10);
    ctx.restore();
  }

  function slotColor(r, slot){
    const palettes = [theme.neonC, theme.neonA, theme.neonB];
    const base = palettes[r % palettes.length];
    const alpha = .22;
    return hexToRgba(base, alpha);
  }

  function drawMatchBox(r, m, x, y, w, h, slotH){
    const radius = 12;
    roundRect(ctx, x, y, w, h, radius);
    const grad = ctx.createLinearGradient(x, y, x, y+h);
    grad.addColorStop(0, 'rgba(255,255,255,.04)');
    grad.addColorStop(1, 'rgba(0,0,0,.25)');
    ctx.fillStyle = grad;
    ctx.fill();

    ctx.fillStyle = slotColor(r,0);
    roundRect(ctx, x+4, y+4, w-8, slotH-6, 8);
    ctx.fill();
    ctx.fillStyle = slotColor(r,1);
    roundRect(ctx, x+4, y+slotH+2, w-8, slotH-6, 8);
    ctx.fill();

    ctx.strokeStyle = 'rgba(255,255,255,.06)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x+8, y+slotH);
    ctx.lineTo(x+w-8, y+slotH);
    ctx.stroke();

    ctx.fillStyle = '#e7efff';
    ctx.font = '600 13px system-ui,Segoe UI,Roboto,Arial';
    ctx.textAlign = 'left';

    const players = matchPlayers(r,m);
    renderPlayer(players[0], x+12, y+slotH/2+4, slotH);
    renderPlayer(players[1], x+12, y+slotH + slotH/2+4, slotH);

    hitRegions.push({round:r, match:m, slot:0, x:x+4, y:y+4, w:w-8, h:slotH-6});
    hitRegions.push({round:r, match:m, slot:1, x:x+4, y:y+slotH+2, w:w-8, h:slotH-6});
  }

  function matchPlayers(r,m){
    const [sA, sB] = state.rounds[r][m] || [];
    const playerA = state.seedToPlayer[sA] || { name: 'TBD' };
    const playerB = state.seedToPlayer[sB] || { name: 'TBD' };
    return [playerA, playerB];
  }

  function coinConfetti(count=20){
    const container=document.createElement('div');
    container.style.position='fixed';container.style.top='0';container.style.left='0';
    container.style.width='100%';container.style.height='0';container.style.pointerEvents='none';
    container.style.zIndex='100';container.style.overflow='visible';
    document.body.appendChild(container);
    for(let i=0;i<count;i++){
      const img=document.createElement('img');
      img.src='/assets/icons/ezgif-54c96d8a9b9236.webp';
      img.className='coin-confetti';
      const left=Math.random()*100; const delay=Math.random()*3; const duration=2+Math.random()*2;
      img.style.left=left+'vw'; img.style.animationDelay=delay+'s'; img.style.setProperty('--duration',duration+'s');
      container.appendChild(img);
    }
    setTimeout(()=>container.remove(),5000);
  }

  function renderPlayer(player, x, y, slotH){
    if(player.name === 'BYE') return;
    const avatarSize = 20;
    if(player.flag){
      ctx.fillText(player.flag, x, y+1);
      ctx.fillText(player.name, x+18, y);
    }else{
      ctx.save();
      ctx.beginPath();
      ctx.arc(x+avatarSize/2, y-8, avatarSize/2, 0, Math.PI*2);
      ctx.fillStyle = '#233155';
      ctx.fill();
      ctx.fillStyle = '#e7efff';
      ctx.font = '600 11px system-ui,Segoe UI,Roboto,Arial';
      ctx.textAlign = 'center';
      ctx.fillText((player.name||'')[0]||'', x+avatarSize/2, y-4);
      ctx.restore();
      ctx.textAlign = 'left';
      ctx.font = '600 13px system-ui,Segoe UI,Roboto,Arial';
      ctx.fillText(player.name, x+avatarSize+6, y);
    }
  }

  function labelForSource(r,m){
    if(r===0){
      const [sA,sB]=state.rounds[0][m];
      return `(${seedShort(sA)} vs ${seedShort(sB)})`;
    }else{
      return `R${r+1}-M${m+1}`;
    }
  }

  function seedShort(s){
    const n = state.seedToPlayer[s].name;
    if(n==='BYE') return 'BYE';
    if(/^Team \d+$/i.test(n)) return n.replace('Team ', '#');
    return n.length>10? n.slice(0,10)+'‚Ä¶': n;
  }

  function drawCenterLabels(w){
    ctx.save();
    ctx.textAlign = 'center';
    ctx.font = '700 20px system-ui,Segoe UI,Roboto,Arial';
    ctx.fillStyle = '#e8f0ff';
    ctx.fillText('THE PLAYOFFS', w/2, 34);
    ctx.font = '600 12px system-ui,Segoe UI,Roboto,Arial';
    ctx.fillStyle = '#9fb3de';
    ctx.fillText('WORLD CHAMPIONSHIP', w/2, 54);
    ctx.restore();
  }

  function hexToRgba(hex, a){
    let c = hex.replace('#','');
    if(c.length===3){ c = c.split('').map(x=>x+x).join(''); }
    const num = parseInt(c,16);
    const r = (num>>16)&255, g=(num>>8)&255, b=num&255;
    return `rgba(${r},${g},${b},${a})`;
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.lineTo(x+w-rr, y);
    ctx.quadraticCurveTo(x+w, y, x+w, y+rr);
    ctx.lineTo(x+w, y+h-rr);
    ctx.quadraticCurveTo(x+w, y+h, x+w-rr, y+h);
    ctx.lineTo(x+rr, y+h);
    ctx.quadraticCurveTo(x, y+h, x, y+h-rr);
    ctx.lineTo(x, y+rr);
    ctx.quadraticCurveTo(x, y, x+rr, y);
    ctx.closePath();
  }

  canvas.addEventListener('click', ()=>{
    // Name editing disabled in tournament view
  });

  function getNameAt(r,m,slot){
    const [a,b] = matchPlayers(r,m);
    return slot===0? a.name : b.name;
  }

  function setNameAt(r,m,slot,newName){
    if(r===0){
      const seed = state.rounds[0][m][slot];
      state.seedToPlayer[seed].name = newName;
    }else{
      alert('Names in this round are auto-filled from previous matches.');
    }
  }

  function simulateRoundAI(st, round){
    const next = st.rounds[round+1];
    const userSeed = st.userSeed;
    st.rounds[round].forEach((pair, idx) => {
      if(pair.includes(userSeed)) return;
      if(next && next[Math.floor(idx/2)][idx%2]) return;
      const s1 = pair[0];
      const s2 = pair[1];
      const p1 = st.seedToPlayer[s1];
      const p2 = st.seedToPlayer[s2];
      let w;
      if(p1 && p1.name==='BYE') w = s2;
      else if(p2 && p2.name==='BYE') w = s1;
      else w = Math.random() < 0.5 ? s1 : s2;
      if(next) next[Math.floor(idx/2)][idx%2] = w;
      else { st.championSeed = w; st.complete = true; }
    });
  }

  function getUserMatch(st){
    const r = st.currentRound || 0;
    const userSeed = st.userSeed;
    const roundMatches = st.rounds[r] || [];
    for(let i=0;i<roundMatches.length;i++){
      const pair = roundMatches[i];
      const next = st.rounds[r+1] && st.rounds[r+1][Math.floor(i/2)][i%2];
      if(next) continue;
      if(pair[0]===userSeed || pair[1]===userSeed){
        const oppSeed = pair[0]===userSeed? pair[1]:pair[0];
        const opp = st.seedToPlayer[oppSeed];
        if(opp && opp.name==='BYE'){
          if(st.rounds[r+1]) st.rounds[r+1][Math.floor(i/2)][i%2]=userSeed;
          simulateRoundAI(st, r);
          if(st.rounds[r].every((p,idx)=> st.rounds[r+1][Math.floor(idx/2)][idx%2])){
            st.currentRound++;
          }
          localStorage.setItem(STATE_KEY, JSON.stringify(st));
          layoutAndDraw();
          return null;
        }
        return {round:r, match:i, pair};
      }
    }
    return null;
  }

  function startNextMatch(){
    const st = state;
    const info = getUserMatch(st);
    if(!info) return;
    st.pendingMatch = info;
    const opponentSeed = info.pair[0] === st.userSeed ? info.pair[1] : info.pair[0];
    localStorage.setItem(OPP_KEY, JSON.stringify(st.seedToPlayer[opponentSeed]));
    localStorage.setItem(STATE_KEY, JSON.stringify(st));
    window.location.href = '/free-kick.html' + window.location.search;
  }

  (function init(){
    const totalPlayers = parseInt(params.get('players') || '8', 10);
    const saved = localStorage.getItem(STATE_KEY);
    if(saved){
      try{
        const parsed = JSON.parse(saved);
        if(parsed.N === totalPlayers){
          state = parsed;
        }
      }catch{}
    }
    if(!state.rounds.length){
      const userName = params.get('name') || 'You';
      const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
      function flagToName(flag){
        const codes = Array.from(flag).map(c => c.codePointAt(0) - 0x1F1E6 + 65);
        return regionNames.of(String.fromCharCode(...codes)) || 'CPU';
      }
      function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
      const flags = [...(window.FLAG_EMOJIS || [])];
      shuffle(flags);
      const players = [{ name: userName, flag: params.get('flag') || 'üè≥Ô∏è' }];
      for(let i=0;i<totalPlayers-1;i++){
        const f=flags[i];
        players.push({ name: flagToName(f), flag: f });
      }
      state.players = players;
      createBracket(players);
      state.userSeed = 1;
      state.currentRound = 0;
      state.championSeed = 0;
      state.complete = false;
      localStorage.setItem(STATE_KEY, JSON.stringify(state));
    }
    layoutAndDraw();
    window.addEventListener('resize', ()=> layoutAndDraw());

    function showExitPopup(){
      if(document.getElementById('tournExit')) return;
      const tg = window.Telegram?.WebApp;
      const overlay=document.createElement('div');
      overlay.id='tournExit';
      overlay.style.position='fixed';overlay.style.inset='0';
      overlay.style.background='rgba(0,0,0,0.6)';
      overlay.style.display='flex';overlay.style.flexDirection='column';
      overlay.style.alignItems='center';overlay.style.justifyContent='center';
      const box=document.createElement('div');
      box.style.background='#11172a';box.style.padding='20px';box.style.borderRadius='8px';box.style.textAlign='center';box.style.maxWidth='90%';box.style.color='#dbe7ff';
      box.innerHTML='<p style="margin-bottom:12px;">If you quit the tournament, your funds will be lost and you will be placed last.</p>';
      const quit=document.createElement('button');
      quit.textContent='Quit Tournament';
      quit.style.margin='4px';quit.style.padding='8px 12px';
      quit.style.background='#f97316';quit.style.border='none';
      quit.style.borderRadius='4px';quit.style.color='#fff';
      const ret=document.createElement('button');
      ret.textContent='Return to Lobby';
      ret.style.margin='4px';ret.style.padding='8px 12px';
      ret.style.background='#2563eb';ret.style.border='none';
      ret.style.borderRadius='4px';ret.style.color='#fff';
      box.appendChild(quit);box.appendChild(ret);overlay.appendChild(box);document.body.appendChild(overlay);
      quit.onclick=()=>{localStorage.removeItem(STATE_KEY);localStorage.removeItem(OPP_KEY);if(tg) tg.BackButton.hide();window.location.href='/games/freekick/lobby';};
      ret.onclick=()=>{document.body.removeChild(overlay);if(tg) tg.BackButton.show();};
    }
    const tg = window.Telegram?.WebApp;
    if(tg){ tg.BackButton.show(); tg.onEvent('backButtonClicked', showExitPopup); tg.onEvent('close', showExitPopup); }
    history.pushState(null,'',location.href);
    window.addEventListener('popstate', (e)=>{ e.preventDefault(); showExitPopup(); history.pushState(null,'',location.href); });

    const btn = document.getElementById('continueBtn');
    if(state.complete){
      const champ = state.seedToPlayer[state.championSeed] || {};
      coinConfetti(30);
      const overlay=document.createElement('div');
      overlay.style.position='fixed';overlay.style.inset='0';overlay.style.display='flex';overlay.style.flexDirection='column';
      overlay.style.alignItems='center';overlay.style.justifyContent='center';overlay.style.background='rgba(0,0,0,0.6)';
      const av=document.createElement('div');
      av.style.width='120px';av.style.height='120px';av.style.borderRadius='50%';av.style.background='#fff';av.style.display='flex';
      av.style.alignItems='center';av.style.justifyContent='center';av.style.fontSize='64px';
      av.textContent=champ.flag||'';overlay.appendChild(av);
      const last=JSON.parse(localStorage.getItem(`freeKickLastResult_${tgKey}`)||'{}');
      if(last.p1!=null && last.p2!=null){
        const res=document.createElement('div');res.style.color='#fff';res.style.marginTop='8px';res.textContent=`${last.p1}-${last.p2}`;
        overlay.appendChild(res);
      }
      const prize=document.createElement('div');
      prize.style.display='flex';prize.style.alignItems='center';prize.style.gap='4px';prize.style.marginTop='8px';
      const icon=document.createElement('img');icon.src='/assets/icons/ezgif-54c96d8a9b9236.webp';icon.style.width='24px';icon.style.height='24px';
      prize.appendChild(icon);
      const amt=document.createElement('span');amt.textContent=String(state.pot);prize.appendChild(amt);
      overlay.appendChild(prize);
      btn.textContent='Return to Lobby';
      btn.style.marginTop='12px';
      btn.addEventListener('click', ()=>{
        localStorage.removeItem(STATE_KEY);
        localStorage.removeItem(OPP_KEY);
        localStorage.removeItem(`freeKickLastResult_${tgKey}`);
        window.location.href='/games/freekick/lobby';
      });
      overlay.appendChild(btn);
      document.body.appendChild(overlay);
    } else {
      btn.addEventListener('click', startNextMatch);
    }
  })();
})();
</script>
</body>
</html>
